# 维修工地区同步更新说明

## 概述
维修工在工作台页面更新注册地区后，该地区信息会自动同步到所有显示维修工信息的页面，包括主管端、超级管理员端和分配维修工等页面。

## 修改内容

### 1. 云函数修改 (`cloud/functions/issues/index.js`)

#### 1.1 `getWorkerList` 函数（获取维修工列表）
- **位置**: 第 3991-4167 行
- **修改内容**:
  - 添加 `region` 字段到返回数据中
  - 优先使用 `region` 字段（格式：省-市）
  - 如果 `region` 存在，从中提取 `province` 和 `city`
  - 如果 `region` 不存在但有 `province` 和 `city`，则拼接生成 `region`
  - 支持通过 `region` 字段进行地区筛选查询
  - 关键词搜索新增对 `region` 字段的支持

#### 1.2 `getWorkerDetail` 函数（获取维修工详情）
- **位置**: 第 4293-4443 行
- **修改内容**:
  - 添加 `region` 字段到返回数据中
  - 处理逻辑与 `getWorkerList` 相同

#### 1.3 `getAllUsers` 函数（超级管理员获取所有用户）
- **位置**: 第 1640-1717 行
- **修改内容**:
  - 添加 `region`、`province`、`city` 字段到返回数据中
  - 优先使用 `region` 字段（格式：省-市）
  - 如果 `region` 存在，从中提取 `province` 和 `city`
  - 如果 `region` 不存在但有 `province` 和 `city`，则拼接生成 `region`

#### 1.4 `getWorkers` 函数（主管获取维修工列表）
- **位置**: 第 1162-1238 行
- **状态**: 已支持 `region` 字段（无需修改）

### 2. 数据结构

#### 维修工数据返回格式
```javascript
{
  _id: 'worker_id',
  name: '维修工姓名',
  phone: '手机号',
  province: '省份',      // 从 region 提取或原有字段
  city: '城市',          // 从 region 提取或原有字段
  region: '省份-城市',   // 新增：完整地区信息
  storeName: '门店名称',
  address: '详细地址',
  registerTime: '注册时间',
  completedCount: 0,
  processingCount: 0,
  averageRating: 0
}
```

## 地区数据优先级

1. **存储优先级**: `region` 字段（格式：省-市）
2. **显示优先级**:
   - 如果有 `region`：优先使用 `region` 字段
   - 如果没有 `region`：使用 `province - city` 拼接显示

## 查询支持

云函数现在支持以下三种方式查询维修工地区：

1. **通过 province 字段查询**
2. **通过 city 字段查询**
3. **通过 region 字段查询**（新增）

查询时会使用 OR 逻辑，同时匹配以上三种方式，确保兼容新旧数据。

## 前端页面显示

所有显示维修工地区的页面都已支持显示 `region` 字段：

### 主管端
- **维修工列表页** (`pages/manager/personnel-manager/`)
  - 显示：`{{item.province}} - {{item.city}}`
  - 显示：`{{item.region}}`
  
- **维修工详情页** (`pages/manager/worker-detail/`)
  - 显示：`{{workerInfo.province}} - {{workerInfo.city}}`
  - 显示：`{{workerInfo.region}}`

- **分配维修工** (`pages/manager/pending/pending.wxml`)
  - 显示：`{{item.region}}`

### 超级管理员端
- **用户管理页** (`pages/admin/user-management/`)
  - 显示：`{{item.region}}`（第 114 行）
  - 移除了随机生成地区的代码
  - 现在直接使用云函数返回的 `region` 字段

### 维修工端
- **工作台** (`pages/worker/index/`)
  - 可以选择和更新注册地区
  - 保存格式：`省-市`
  - 保存到数据库的 `region` 字段

## 数据同步机制

1. **维修工更新地区**:
   - 维修工在工作台点击"注册地区"
   - 通过自定义选择器选择省市
   - 调用云函数 `auth.updateUserLocation`
   - 保存到数据库 `users` 集合的 `region` 字段

2. **其他页面显示**:
   - 调用 `getWorkerList` 或 `getWorkerDetail` 云函数
   - 云函数从数据库读取 `region` 字段
   - 自动解析并返回 `province`、`city`、`region` 三个字段
   - 前端页面直接显示

## 兼容性

- ✅ 兼容旧数据（只有 province 和 city 字段的维修工）
- ✅ 兼容新数据（使用 region 字段的维修工）
- ✅ 支持渐进式迁移（新旧数据并存）

## 测试建议

1. **新注册维修工**: 选择地区后，检查所有页面是否正确显示
2. **旧数据维修工**: 更新地区后，检查是否正常保存和显示
3. **地区筛选**: 在维修工列表页测试地区筛选功能
4. **关键词搜索**: 测试通过地区名称搜索维修工

## 部署步骤

1. 上传修改后的云函数：
   ```bash
   # 在微信开发者工具中右键 cloud/functions/issues 文件夹
   # 选择"上传并部署：云端安装依赖"
   ```

2. 测试云函数是否正常工作

3. 验证所有页面的地区显示是否正确

## 注意事项

- 云函数修改后需要重新部署
- 建议在测试环境先测试，确认无误后再部署到生产环境
- 如果有大量旧数据，建议编写数据迁移脚本批量更新 `region` 字段

