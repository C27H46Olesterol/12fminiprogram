# 故障警告功能 - 实现总结

## ✅ 已完成功能

### 概述
在 `pages/client/index` 中添加了设备故障警告系统，当 `deviceStatus.err` 不为0时，在界面顶部显示一个模态警告框，展示故障代码及其详细信息。

### 实现的组件

#### 1. 故障代码数据 (`utils/faultCodes.js`)
- ✅ 创建了故障代码映射表
- ✅ 包含 E1-E10 的故障信息
- ✅ 每个故障包含：code、title、cause、solutions

#### 2. JavaScript 逻辑 (`pages/client/index/index.js`)

**新增数据字段：**
```javascript
data: {
  showFaultAlert: false,      // 是否显示故障警告
  currentFaultInfo: null       // 当前故障信息
}
```

**新增方法：**
1. `checkFaultStatus(newStatus)` - 检查故障状态
   - 解析 err 代码
   - 获取对应故障信息
   - 显示警告弹窗
   - 震动提醒用户

2. `closeFaultAlert()` - 关闭故障警告

3. `goToManual()` - 跳转到维修手册页面

**集成点：**
- ✅ 在 `parseBluetoothData()` 方法中，更新设备状态后调用 `checkFaultStatus()`
- ✅ 实时监测设备故障状态并自动弹出警告

#### 3. UI 界面 (`pages/client/index/index.wxml`)

**故障警告模态框包含：**
- ✅ 全屏遮罩层（点击关闭）
- ✅ 故障信息卡片
  - 头部：故障代码 + 标题 + 关闭按钮
  - 可能原因区域
  - 解决方案列表
  - 底部操作按钮（忽略/查看手册）

**特性：**
- ✅ 响应式设计
- ✅ 动画效果（淡入、滑入）
- ✅ 可滚动内容区域

#### 4. 样式设计 (`pages/client/index/index.wxss`)

**设计亮点：**
- ✅ 渐变背景（红色警告主题）
- ✅ 动画效果：
  - fadeIn - 遮罩淡入
  - slideUp - 内容滑入
  - pulse - 图标脉动
- ✅ 卡片式布局
- ✅ 视觉分层：
  - 原因区域：橙色边框 + 浅黄背景
  - 解决方案：绿色边框 + 浅绿背景
- ✅ 响应式按钮设计

## 📱 用户体验流程

### 正常场景
```
设备运行 (err = 0)
  ↓
无故障警告显示
```

### 故障场景
```
设备检测到故障 (err > 0)
  ↓
蓝牙数据解析 (parseBluetoothData)
  ↓
更新 deviceStatus.err
  ↓
调用 checkFaultStatus()
  ↓
查找FAULT_CODES[errCode]
  ↓
显示故障警告弹窗 + 震动提醒
  ↓
用户操作：
  ├─ 点击"暂时忽略" → 关闭弹窗
  ├─ 点击"查看维修手册" → 跳转到 /pages/manual
  └─ 点击遮罩 → 关闭弹窗
```

### 故障清除场景
```
设备故障清除 (err = 0)
  ↓
checkFaultStatus() 检测到 err = 0
  ↓
自动关闭警告弹窗
  ↓
控制台输出: "[Fault] 故障已清除"
```

## 🎨 界面设计

### 颜色方案
- **警告主色**：#ff4d4f → #ff7875 (红色渐变)
- **原因背景**：#fff7e6 (浅黄)
- **原因边框**：#ffa940 (橙色)
- **方案背景**：#f6ffed (浅绿)
- **方案边框**：#52c41a (绿色)
- **主按钮**：#1890ff → #096dd9 (蓝色渐变)

### 动画时间
- 淡入/滑入：0.3秒
- 脉动动画：2秒循环

## 📋 故障代码列表

| 代码 | 标题 | 描述 |
|------|------|------|
| E1/LU | 电池电压过低 | 显示屏检测到电压过低 |
| E2 | 压缩机发热/电流保护 | 压缩机发热或过流保护 |
| E3 | 堵转保护 | 压缩机堵转 |
| E4 | 控制器低压保护 | 控制器测得母线电压不足 |
| E5 | 控制器故障 | 控制器芯片或元器件损坏 |
| E6 | 风机故障/过流 | 风机过流保护或电子故障 |
| E7 | 压缩机缺相 | 压缩机三相不平衡 |
| E8-E10 | 风机故障 | 风机过流保护或电子故障 |

## 🔧 代码修改点

### 1. 新增文件
- `utils/faultCodes.js` - 故障代码数据

### 2. 修改文件
- `pages/client/index/index.js`
  - 引入 FAULT_CODES
  - 添加 data 字段
  - 添加 3 个新方法
  - 在 parseBluetoothData 中调用 checkFaultStatus

- `pages/client/index/index.wxml`
  - 添加故障警告模态框UI

- `pages/client/index/index.wxss`
  - 添加完整的故障警告样式

## ⚠️ 注意事项

### 1. 图标资源
- 警告图标路径: `/images/icons/warning.png`
- **需要手动添加该图标文件**
- 替代方案：使用 emoji 或其他现有图标

### 2. 故障代码扩展
如需添加新的故障代码，更新 `utils/faultCodes.js`：
```javascript
const FAULT_CODES = {
  // ...existing codes...
  11: {
    code: 'E11',
    title: '新故障类型',
    cause: '故障原因描述',
    solutions: ['解决方案1', '解决方案2']
  }
};
```

### 3. 震动权限
- 使用了 `wx.vibrateLong()` API
- 需要确保小程序有震动权限

### 4. 未知故障处理
- 如果 err 代码不在 FAULT_CODES 中
- 会显示通用"未知故障"提示
- 建议联系售后服务

## 🧪 测试建议

### 测试场景1：故障触发
1. 模拟设备发送 err = 2 的蓝牙数据
2. 验证弹窗显示 E2 故障信息
3. 验证震动提醒
4. 验证界面显示正确的原因和解决方案

### 测试场景2：故障清除
1. 设备从 err = 2 变为 err = 0
2. 验证弹窗自动关闭
3. 验证控制台输出清除日志

### 测试场景3：用户交互
1. 点击"暂时忽略" → 弹窗关闭
2. 点击"查看维修手册" → 跳转到 /pages/manual
3. 点击遮罩 → 弹窗关闭
4. 点击 X 按钮 → 弹窗关闭

### 测试场景4：未知故障
1. 模拟 err = 99（未定义）
2. 验证显示"未知故障"提示
3. 验证提示联系售后

## ✨ 后续优化建议

1. **持久化忽略**：记录用户已忽略的故障，避免重复弹出
2. **故障历史**：记录故障发生时间和历史
3. **多语言支持**：支持多语言故障描述
4. **一键报修**：添加直接联系客服或报修功能
5. **声音提醒**：配合震动添加音效提醒
6. **故障统计**：统计故障频率，提供维护建议

---

**实现完成时间**: 2025-12-30
**状态**: ✅ 核心功能已完成，可进行测试
**下一步**: 添加 warning.png 图标资源
