<!--pages/worker/task-detail/task-detail.wxml-->
<wxs module="utils">
  // è·å–çŠ¶æ€æ–‡æœ¬
  var getStatusText = function(status) {
    var map = {
      'pending': 'å¾…å¤„ç†',
      'assigned': 'å·²åˆ†é…',
      'processing': 'å¤„ç†ä¸­',
      'parts_request': 'é…ä»¶ç”³è¯·ä¸­',
      'parts_sent': 'é…ä»¶å·²å‘å‡º',
      'parts_received': 'è¿”ä»¶å·²æ”¶åˆ°',
      'resolved': 'å·²è§£å†³',
      'closed': 'å·²å…³é—­',
      'cancelled': 'å·²å–æ¶ˆ'
    };
    return map[status] || 'æœªçŸ¥';
  };

  // è·å–ä¼˜å…ˆçº§æ–‡æœ¬
  var getPriorityText = function(priority) {
    var map = {
      'low': 'ä½',
      'medium': 'ä¸­',
      'high': 'é«˜',
      'urgent': 'ç´§æ€¥'
    };
    return map[priority] || 'æœªè®¾ç½®';
  };

  // è·å–ä¼˜å…ˆçº§é¢œè‰²
  var getPriorityColor = function(priority) {
    var map = {
      'low': '#52c41a',
      'medium': '#1890ff',
      'high': '#fa8c16',
      'urgent': '#f5222d'
    };
    return map[priority] || '#666';
  };

  // æ ¼å¼åŒ–æ—¶é—´
  var formatTime = function(timestamp) {
    if (!timestamp) return '';
    
    var date = getDate(timestamp);
    var year = date.getFullYear();
    var month = (date.getMonth() + 1).toString();
    var day = date.getDate().toString();
    var hours = date.getHours().toString();
    var minutes = date.getMinutes().toString();
    
    if (month.length < 2) month = '0' + month;
    if (day.length < 2) day = '0' + day;
    if (hours.length < 2) hours = '0' + hours;
    if (minutes.length < 2) minutes = '0' + minutes;
    
    return year + '-' + month + '-' + day + ' ' + hours + ':' + minutes;
  };

  module.exports = {
    getStatusText: getStatusText,
    getPriorityText: getPriorityText,
    getPriorityColor: getPriorityColor,
    formatTime: formatTime
  };
</wxs>

<view class="container">
  <!-- é¡µé¢æ ‡é¢˜ -->
  <view class="header">
    <text class="title">ä»»åŠ¡è¯¦æƒ…</text>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{isLoading}}" class="loading">
    <text>åŠ è½½ä¸­...</text>
  </view>

  <!-- ä»»åŠ¡è¯¦æƒ… -->
  <view wx:else class="task-detail">
    <!-- åŸºæœ¬ä¿¡æ¯ -->
    <view class="section">
      <view class="section-title">åŸºæœ¬ä¿¡æ¯</view>
      <view class="info-item">
        <text class="label">ä»»åŠ¡ç¼–å·ï¼š</text>
        <text class="value">{{task.issueId}}</text>
      </view>
      <view class="info-item">
        <text class="label">ä»»åŠ¡æ ‡é¢˜ï¼š</text>
        <text class="value">{{task.title}}</text>
      </view>
      <view class="info-item">
        <text class="label">é—®é¢˜æè¿°ï¼š</text>
        <text class="value">{{task.description}}</text>
      </view>
      <view class="info-item">
        <text class="label">é—®é¢˜åˆ†ç±»ï¼š</text>
        <text class="value">{{task.category}}</text>
      </view>
      <view class="info-item">
        <text class="label">ä¼˜å…ˆçº§ï¼š</text>
        <text class="value priority" style="color: {{utils.getPriorityColor(task.priority)}}">
          {{utils.getPriorityText(task.priority)}}
        </text>
      </view>
      <view class="info-item">
        <text class="label">å½“å‰çŠ¶æ€ï¼š</text>
        <text class="value status">{{utils.getStatusText(task.status)}}</text>
      </view>
      <view class="info-item">
        <text class="label">åˆ†é…æ—¶é—´ï¼š</text>
        <text class="value">{{utils.formatTime(task.assignedTime)}}</text>
      </view>
    </view>

    <!-- å®¢æˆ·ä¿¡æ¯ -->
    <view class="section">
      <view class="section-title">å®¢æˆ·ä¿¡æ¯</view>
      <view class="info-item">
        <text class="label">å®¢æˆ·å§“åï¼š</text>
        <text class="value">{{task.clientName}}</text>
      </view>
      <view class="info-item">
        <text class="label">è”ç³»ç”µè¯ï¼š</text>
        <text class="value phone" bindtap="onCallPhone" data-phone="{{task.clientPhone}}">
          {{task.clientPhone}}
        </text>
      </view>
      <view class="info-item">
        <text class="label">å®‰è£…åœ°å€ï¼š</text>
        <text class="value">{{task.clientAddress}}</text>
      </view>
      <view class="info-item">
        <text class="label">äº§å“å‹å·ï¼š</text>
        <text class="value">{{task.productModel}}</text>
      </view>
      <view class="info-item" wx:if="{{task.bestContactTime}}">
        <text class="label">æœ€ä½³è”ç³»æ—¶é—´ï¼š</text>
        <text class="value">{{task.bestContactTime}}</text>
      </view>
    </view>

    <!-- å®¢æˆ·è¯„ä»· -->
    <view class="section" wx:if="{{task.satisfaction > 0}}">
      <view class="section-title">å®¢æˆ·è¯„ä»·</view>
      <view class="info-item">
        <text class="label">æœåŠ¡è¯„åˆ†ï¼š</text>
        <view class="rating-display">
          <view class="stars">
            <text wx:for="{{[1,2,3,4,5]}}" wx:key="index" class="star {{task.satisfaction >= item ? 'active' : ''}}">â˜…</text>
          </view>
          <text class="rating-text" style="color: {{getRatingColor(task.satisfaction)}}">
            {{getRatingText(task.satisfaction)}}
          </text>
        </view>
      </view>
      <view class="info-item" wx:if="{{task.feedback}}">
        <text class="label">è¯„ä»·å†…å®¹ï¼š</text>
        <text class="value feedback-content">{{task.feedback}}</text>
      </view>
    </view>

    <!-- å¤„ç†ä¿¡æ¯ -->
    <view class="section" wx:if="{{task.processingTime || task.resolvedTime}}">
      <view class="section-title">å¤„ç†ä¿¡æ¯</view>
      <view class="info-item" wx:if="{{task.processingTime}}">
        <text class="label">å¼€å§‹å¤„ç†ï¼š</text>
        <text class="value">{{utils.formatTime(task.processingTime)}}</text>
      </view>
      <view class="info-item" wx:if="{{task.resolvedTime}}">
        <text class="label">å®Œæˆæ—¶é—´ï¼š</text>
        <text class="value">{{utils.formatTime(task.resolvedTime)}}</text>
      </view>
      <view class="info-item" wx:if="{{task.resultDescription}}">
        <text class="label">å¤„ç†ç»“æœï¼š</text>
        <text class="value">{{task.resultDescription}}</text>
      </view>
      <view class="info-item" wx:if="{{task.projectType}}">
        <text class="label">é¡¹ç›®ç±»å‹ï¼š</text>
        <text class="value">{{task.projectType}}</text>
      </view>
      <view class="info-item" wx:elif="{{task.workHours}}">
        <text class="label">å·¥ä½œæ—¶é•¿ï¼š</text>
        <text class="value">{{task.workHours}} å°æ—¶</text>
      </view>
    </view>

    <!-- ä»»åŠ¡è¿›åº¦è¯¦æƒ… -->
    <view class="section" wx:if="{{task.status !== 'assigned'}}">
      <view class="section-title">ä»»åŠ¡è¿›åº¦è¯¦æƒ…</view>
      
      <!-- æ˜¯å¦éœ€è¦é…ä»¶ -->
      <view class="info-item" wx:if="{{task.status === 'processing' || task.status === 'parts_sent' || task.status === 'parts_received' || task.status === 'resolved'}}">
        <text class="label">æ˜¯å¦éœ€è¦é…ä»¶ï¼š</text>
        <text class="value">{{task.needParts ? 'éœ€è¦' : 'ä¸éœ€è¦'}}</text>
      </view>
      
      <!-- é…ä»¶è¯¦æƒ…ï¼ˆå¦‚æœéœ€è¦é…ä»¶ï¼‰ -->
      <view wx:if="{{task.needParts && task.partsDetail}}" class="info-item">
        <text class="label">é…ä»¶è¯¦æƒ…ï¼š</text>
        <text class="value">{{task.partsDetail}}</text>
      </view>
      
      <!-- é—®é¢˜è¯Šæ–­æè¿°ï¼ˆå‘å‡ºé…ä»¶æ—¶çš„æè¿°ï¼‰ -->
      <view wx:if="{{task.problemDescription}}" class="info-item">
        <text class="label">é—®é¢˜è¯Šæ–­ï¼š</text>
        <text class="value">{{task.problemDescription}}</text>
      </view>
      
      <!-- é…ä»¶å‘å‡ºæ—¶é—´ -->
      <view wx:if="{{task.partsSentTime}}" class="info-item">
        <text class="label">é…ä»¶å‘å‡ºæ—¶é—´ï¼š</text>
        <text class="value">{{utils.formatTime(task.partsSentTime)}}</text>
      </view>
      
      <!-- é…ä»¶å‘å‡ºæ“ä½œäºº -->
      <view wx:if="{{task.partsSentByName}}" class="info-item">
        <text class="label">é…ä»¶å‘å‡ºäººï¼š</text>
        <text class="value">{{task.partsSentByName}}</text>
      </view>
      
      <!-- è¿”ä»¶å‘å‡ºæ—¶é—´ -->
      <view wx:if="{{task.partsReturnedTime}}" class="info-item">
        <text class="label">è¿”ä»¶å‘å‡ºæ—¶é—´ï¼š</text>
        <text class="value">{{utils.formatTime(task.partsReturnedTime)}}</text>
      </view>
      
      <!-- è¿”ä»¶å‘å‡ºæ“ä½œäºº -->
      <view wx:if="{{task.partsReturnedByName}}" class="info-item">
        <text class="label">è¿”ä»¶å‘å‡ºäººï¼š</text>
        <text class="value">{{task.partsReturnedByName}}</text>
      </view>
      
      <!-- è¿”ä»¶å¿«é€’å•å· -->
      <view wx:if="{{task.trackingNumber}}" class="info-item">
        <text class="label">è¿”ä»¶å¿«é€’å•å·ï¼š</text>
        <text class="value">{{task.trackingNumber}}</text>
      </view>
      
      <!-- è¿”ä»¶å›¾ç‰‡ -->
      <view wx:if="{{task.partsImages && task.partsImages.length > 0}}" class="info-item" style="flex-direction: column; align-items: flex-start;">
        <text class="label" style="margin-bottom: 15rpx;">è¿”ä»¶å›¾ç‰‡ï¼š</text>
        <view class="images" style="display: flex; flex-wrap: wrap; gap: 15rpx;">
          <image 
            wx:for="{{task.partsImages}}" 
            wx:key="index"
            src="{{item}}" 
            class="parts-image"
            style="width: 200rpx; height: 200rpx; border-radius: 8rpx;"
            mode="aspectFill"
            bindtap="onPreviewPartsImage"
            data-src="{{item}}"
            data-urls="{{task.partsImages}}"
          />
        </view>
      </view>
      
      <!-- è¿”ä»¶æ”¶åˆ°æ—¶é—´ -->
      <view wx:if="{{task.partsReceivedTime}}" class="info-item">
        <text class="label">è¿”ä»¶æ”¶åˆ°æ—¶é—´ï¼š</text>
        <text class="value">{{utils.formatTime(task.partsReceivedTime)}}</text>
      </view>
      
      <!-- è¿”ä»¶æ”¶åˆ°æ“ä½œäºº -->
      <view wx:if="{{task.partsReceivedByName}}" class="info-item">
        <text class="label">è¿”ä»¶æ”¶åˆ°äººï¼š</text>
        <text class="value">{{task.partsReceivedByName}}</text>
      </view>
      
      <!-- è¿”ä»¶å¤‡æ³¨ -->
      <view wx:if="{{task.receivedNote}}" class="info-item">
        <text class="label">è¿”ä»¶å¤‡æ³¨ï¼š</text>
        <text class="value">{{task.receivedNote}}</text>
      </view>
    </view>

    <!-- å›¾ç‰‡ä¿¡æ¯ -->
    <view class="section" wx:if="{{task.images && task.images.length > 0}}">
      <view class="section-title">ç›¸å…³å›¾ç‰‡</view>
      <view class="images">
        <image 
          wx:for="{{task.images}}" 
          wx:key="index"
          src="{{item}}" 
          class="image"
          bindtap="onPreviewImage"
          data-src="{{item}}"
        />
      </view>
    </view>

    <!-- è°ƒè¯•ä¿¡æ¯ï¼ˆå¼€å‘æ—¶å¯è§ï¼‰ -->
    <view class="debug-info" style="background: #f0f0f0; padding: 20rpx; margin: 20rpx; border-radius: 10rpx; font-size: 24rpx; line-height: 1.8;">
      <text style="display: block; font-weight: bold; margin-bottom: 10rpx;">ğŸ” å®æ—¶è°ƒè¯•ä¿¡æ¯</text>
      <text style="display: block;">â€¢ å½“å‰çŠ¶æ€: {{task.status}}</text>
      <text style="display: block;">â€¢ æ˜¯å¦å¤„ç†ä¸­: {{isProcessing ? 'æ˜¯' : 'å¦'}}</text>
      <text style="display: block;">â€¢ æ˜¾ç¤º"å¼€å§‹å¤„ç†": {{task.status === 'assigned' ? 'æ˜¯' : 'å¦'}}</text>
      <text style="display: block;">â€¢ æ˜¾ç¤º"å®Œæˆä»»åŠ¡": {{task.status === 'processing' ? 'æ˜¯' : 'å¦'}}</text>
      <text style="display: block; color: #999; margin-top: 10rpx; font-size: 20rpx;">æç¤ºï¼šçŠ¶æ€æ›´æ–°åï¼Œå¯¹åº”æŒ‰é’®åº”è¯¥è‡ªåŠ¨åˆ‡æ¢</text>
    </view>

    <!-- æ“ä½œæŒ‰é’® -->
    <view class="actions">
      <!-- å·²åˆ†é…çŠ¶æ€ï¼šæ˜¾ç¤ºå¼€å§‹å¤„ç† -->
      <button 
        wx:if="{{task.status === 'assigned'}}"
        class="btn primary" 
        bindtap="onStartTask"
        disabled="{{isProcessing}}"
      >
        {{isProcessing ? 'å¤„ç†ä¸­...' : 'å¼€å§‹å¤„ç†'}}
      </button>
      
      <!-- å¤„ç†ä¸­çŠ¶æ€ï¼šæ ¹æ®æ˜¯å¦éœ€è¦é…ä»¶æ˜¾ç¤ºä¸åŒæŒ‰é’® -->
      <!-- ä¸éœ€è¦é…ä»¶ï¼šç›´æ¥æ˜¾ç¤ºå®Œæˆä»»åŠ¡ -->
      <button 
        wx:if="{{task.status === 'processing' && !task.needParts}}"
        class="btn success" 
        bindtap="onShowCompleteModal"
        disabled="{{isProcessing}}"
      >
        å®Œæˆä»»åŠ¡
      </button>
      
      <!-- éœ€è¦é…ä»¶ï¼šç»´ä¿®å·¥æ˜¾ç¤ºç”³è¯·å‘å‡ºé…ä»¶æŒ‰é’® -->
      <button 
        wx:if="{{task.status === 'processing' && task.needParts}}"
        class="btn warning" 
        bindtap="onRequestParts"
        disabled="{{isProcessing}}"
      >
        ç”³è¯·å‘å‡ºé…ä»¶
      </button>
      
      <!-- é…ä»¶ç”³è¯·ä¸­çŠ¶æ€ï¼šæ˜¾ç¤ºç­‰å¾…å®¡æ‰¹æç¤º -->
      <button 
        wx:if="{{task.status === 'parts_request'}}"
        class="btn secondary" 
        disabled="true"
      >
        ç­‰å¾…ä¸»ç®¡å®¡æ‰¹
      </button>
      
      <!-- é…ä»¶å·²å‘å‡ºçŠ¶æ€ï¼šæ˜¾ç¤ºå‘å‡ºè¿”ä»¶æŒ‰é’®ï¼ˆä¸»ç®¡å’Œç»´ä¿®å·¥éƒ½å¯ä»¥æ“ä½œï¼‰ -->
      <button 
        wx:if="{{task.status === 'parts_sent'}}"
        class="btn warning" 
        bindtap="onReturnParts"
        disabled="{{isProcessing}}"
      >
        å‘å‡ºè¿”ä»¶
      </button>
      
      <!-- è¿”ä»¶å·²æ”¶åˆ°çŠ¶æ€ï¼šç»´ä¿®å·¥ä¸èƒ½å®Œæˆä»»åŠ¡ï¼Œæ˜¾ç¤ºç­‰å¾…ä¸»ç®¡å®Œæˆ -->
      <button 
        wx:if="{{task.status === 'parts_received'}}"
        class="btn secondary" 
        disabled="true"
      >
        ç­‰å¾…ä¸»ç®¡å®Œæˆä»»åŠ¡
      </button>
      
      <!-- ç”³è¯·ååŠ©ï¼ˆæ‰€æœ‰è¿›è¡Œä¸­çš„ä»»åŠ¡éƒ½å¯ä»¥ç”³è¯·ï¼‰ -->
      <button 
        wx:if="{{task.status === 'assigned' || task.status === 'processing' || task.status === 'parts_sent'}}"
        class="btn secondary" 
        bindtap="onShowHelpModal"
        disabled="{{isProcessing}}"
      >
        ç”³è¯·ååŠ©
      </button>
    </view>

    <!-- çŠ¶æ€å†å² -->
    <view class="section" wx:if="{{history && history.length > 0}}">
      <view class="section-title">çŠ¶æ€å†å²</view>
      <view class="history-list">
        <view 
          wx:for="{{history}}" 
          wx:key="index"
          class="history-item"
        >
          <view class="history-time">{{utils.formatTime(item.createTime || item.timestamp)}}</view>
          <view class="history-content">
            <text class="history-status">{{utils.getStatusText(item.status)}}</text>
            <text class="history-operator">{{item.operatorName}}</text>
            <text class="history-remark" wx:if="{{item.remark}}">{{item.remark}}</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- å®Œæˆä»»åŠ¡å¼¹çª— -->
  <view class="modal" wx:if="{{showCompleteModal}}">
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">å®Œæˆä»»åŠ¡</text>
        <text class="modal-close" bindtap="onHideCompleteModal">Ã—</text>
      </view>
      <view class="modal-body">
        <view class="input-group">
          <text class="input-label">å¤„ç†ç»“æœï¼š</text>
          <textarea 
            class="textarea"
            placeholder="è¯·è¯¦ç»†æè¿°å¤„ç†è¿‡ç¨‹å’Œç»“æœ"
            value="{{resultDescription}}"
            bindinput="onResultDescriptionInput"
            maxlength="500"
          />
        </view>
      </view>
      <view class="modal-footer">
        <button class="btn secondary" bindtap="onHideCompleteModal">å–æ¶ˆ</button>
        <button class="btn primary" bindtap="onConfirmComplete">ç¡®è®¤å®Œæˆ</button>
      </view>
    </view>
  </view>

  <!-- ç”³è¯·ååŠ©å¼¹çª— -->
  <view class="modal" wx:if="{{showHelpModal}}">
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">ç”³è¯·ååŠ©</text>
        <text class="modal-close" bindtap="onHideHelpModal">Ã—</text>
      </view>
      <view class="modal-body">
        <view class="input-group">
          <text class="input-label">ååŠ©åŸå› ï¼š</text>
          <textarea 
            class="textarea"
            placeholder="è¯·è¯´æ˜éœ€è¦ååŠ©çš„å…·ä½“åŸå› "
            value="{{helpReason}}"
            bindinput="onHelpReasonInput"
            maxlength="300"
          />
        </view>
      </view>
      <view class="modal-footer">
        <button class="btn secondary" bindtap="onHideHelpModal">å–æ¶ˆ</button>
        <button class="btn primary" bindtap="onConfirmHelp">ç¡®è®¤ç”³è¯·</button>
      </view>
    </view>
  </view>
</view>