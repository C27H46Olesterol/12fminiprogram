<!-- pages/client/issuesLog/issuesLog.wxml -->
<view class="container">
  <!-- 顶部搜索与筛选 -->
  <view class="filter-section">
    <view class="search-bar">
      <icon type="search" size="16" color="#999" />
      <input 
        placeholder="搜索SN或故障描述" 
        bindinput="onSearch" 
        value="{{searchQuery}}"
      />
    </view>
    
    <view class="filter-bar">
      <picker mode="date" value="{{filterDate}}" bindchange="onDateFilterChange">
        <view class="filter-item date-picker {{filterDate ? 'active' : ''}}">
          <image class="filter-icon" src="/images/icons/clock.png"></image>
          <text>{{filterDate || '选择日期'}}</text>
          <icon wx:if="{{filterDate}}" type="clear" size="14" catchtap="clearDateFilter" />
        </view>
      </picker>

      <view class="filter-item sort-btn" bindtap="toggleSort">
        <image class="filter-icon" src="/images/icons/menu.png"></image>
        <text>{{sortOrder === 'desc' ? '最新报修' : '最早报修'}}</text>
      </view>
    </view>
  </view>

  <!-- 记录列表 -->
  <scroll-view scroll-y class="record-list">
    <block wx:for="{{filteredRecords}}" wx:key="id">
      <view class="record-card {{item.expanded ? 'expanded' : ''}}">
        <!-- 卡片头部 -->
        <view class="card-header" bindtap="toggleExpand" data-id="{{item.id}}">
          <view class="header-main">
            <view class="sn-row">
              <text class="sn-label">设备SN:</text>
              <text class="sn-value">{{item.sn}}</text>
              <view class="status-tag tag-{{item.statusType}}">{{item.status}}</view>
            </view>
            <view class="sub-info">
              <view class="sub-item">
                <image class="sub-icon" src="/images/icons/clock.png" mode="aspectFit"></image>
                <text>报修时间: {{item.submitDate}}</text>
              </view>
            </view>
          </view>
          <view class="arrow-icon {{item.expanded ? 'up' : 'down'}}"></view>
        </view>

        <!-- 故障简述 (未展开时显示) -->
        <view class="fault-summary" wx:if="{{!item.expanded}}">
          <text class="summary-text">{{item.description}}</text>
        </view>

        <!-- 详细内容 (展开时显示) -->
        <view class="card-detail" wx:if="{{item.expanded}}">
          <view class="detail-section">
            <view class="detail-item">
              <text class="label">故障描述：</text>
              <text class="value">{{item.description}}</text>
            </view>
            <view class="detail-item" wx:if="{{item.feedback}}">
              <text class="label">维修反馈：</text>
              <text class="value text-primary">{{item.feedback}}</text>
            </view>
            <view class="detail-item" wx:else>
              <text class="label">当前进度：</text>
              <text class="value">正在为您联系维修师傅，请耐心等待。</text>
            </view>
          </view>

          <view class="image-group" wx:if="{{item.images.length > 0}}">
            <view class="image-title">故障照片 ({{item.images.length}})</view>
            <view class="image-grid">
              <image 
                wx:for="{{item.images}}" 
                wx:key="*this"
                src="{{item}}" 
                mode="aspectFill"
                bindtap="previewImage"
                data-url="{{item}}"
                data-images="{{item.images}}"
              />
            </view>
          </view>
        </view>
      </view>
    </block>

    <view class="empty-state" wx:if="{{filteredRecords.length === 0}}">
      <image src="/images/icons/note.png" mode="aspectFit" style="width: 120rpx; height: 120rpx; opacity: 0.2; filter: grayscale(1);"></image>
      <text>暂无报修记录</text>
    </view>
    <view class="bottom-safe"></view>
  </scroll-view>
</view>