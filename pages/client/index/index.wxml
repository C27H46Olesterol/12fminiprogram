<!--pages/client/index/index.wxml-->
<view class="container client-home" bindtap="closeAllDropdowns">
  <!-- 刷新停止提示 -->
  <view class="refresh-notify {{showRefreshNotify ? 'show' : ''}}" catchtap="resumeRefresh">
    <text>系统已停止自动刷新以节省电量，点击恢复</text>
    <view class="resume-btn">恢复</view>
  </view>

  <!-- 远程遥控界面 -->
  <view class="section remote-control-section">
    
    <!-- 新的综合头部栏 -->
    <view class="remote-header">
      <!-- 1. 开关 -->
      <view class="header-btn-item" bindtap="togglePower">
        <view class="power-btn {{remoteState.powerOn ? 'active' : ''}}">
          <image class="btn-icon-img" src="/images/icons/power.png" mode="aspectFit"></image>
        </view>
        <text class="btn-label">开关</text>
      </view>

      <!-- 2. 设备选择 -->
      <view class="device-selector-container" catchtap="noOp" catchtap="toggleDeviceModal">
        <view class="device-selector">
          <view class="device-picker-wrap {{deviceStatus.online ? 'online' : 'offline'}}">
            <image class="selected-device-img-large" src="{{selectedDevice.image || '/images/logo.png'}}" mode="aspectFill"></image>
            <text class="picker-arrow-large {{deviceStatus.online ? 'online' : 'offline'}}" ></text>
          </view>
        </view>
        <text class="device-name-footer">{{selectedDevice.name || selectedDevice.sn || '未选择'}}</text>

        <!-- 设备选择下拉菜单 -->
        <view class="dropdown-menu device-dropdown {{showDeviceModal ? 'show' : ''}}">
          <block wx:if="{{!hasUserInfo}}">
            <view class="dropdown-grid">
              <view class="dropdown-item" bindtap="onGoLogin" style="justify-content: center; padding: 20rpx;">
                <text>点击<text style='color:rgb(3, 105, 201);' >登录</text>后选择您的设备</text>
              </view>
            </view>
          </block>
          <block wx:elif="{{deviceList.length === 0}}">
            <view class="dropdown-grid">
              <view class="dropdown-item" bindtap="onActivateProduct" style="justify-content: center; padding: 20rpx;">
                <text>点击连接设备</text>
              </view>
            </view>
          </block>
          <block wx:else>
            <view class="device-list-container">
              <view 
                class="device-list-item {{selectedDeviceIndex === index ? 'selected' : ''}}" 
                wx:for="{{deviceList}}" 
                wx:key="sn" 
                bindtap="onSelectDevice" 
                data-index="{{index}}"
              >
                <!-- 1. 连接方式指示器 -->
                <view class="device-connection-indicator">
                  <block wx:if="{{item.connectionType === 'bluetooth'}}">
                    <image class="connection-icon bluetooth-icon" src="/images/icons/bluetooth.png" mode="aspectFit"></image>
                  </block>
                  <block wx:else>
                    <!-- 4G信号条 -->
                    <view class="signal-bars">
                      <view class="signal-bar {{item.signalStrength >= 1 ? 'active' : ''}}"></view>
                      <view class="signal-bar {{item.signalStrength >= 2 ? 'active' : ''}}"></view>
                      <view class="signal-bar {{item.signalStrength >= 3 ? 'active' : ''}}"></view>
                      <view class="signal-bar {{item.signalStrength >= 4 ? 'active' : ''}}"></view>
                      <view class="signal-bar {{item.signalStrength >= 5 ? 'active' : ''}}"></view>
                    </view>
                  </block>
                </view>

                <!-- 2. 图片 -->
                <image class="device-list-img" src="{{item.image || '/images/logo.png'}}" mode="aspectFill"></image>

                <!-- 3. 信息 -->
                <view class="device-list-info">
                  <view class="info-row">
                    <text class="info-label">设备名称：</text>
                    <text class="info-value">{{item.name || '未命名'}}</text>
                  </view>
                  <view class="info-row">
                    <text class="info-label">设备型号：</text>
                    <text class="info-value">{{item.sn}}</text>
                  </view>
                  <view class="info-row">
                    <text class="info-label">激活日期：</text>
                    <text class="info-value">{{item.activationDate}}</text>
                  </view>
                  <view class="info-row">
                    <text class="info-label">过保日期：</text>
                    <text class="info-value">{{item.warrantyDate}}</text>
                  </view>
                  
                  
                  
                </view>
                <!-- 4. 取消配对按钮 -->
                <view class="device-action-btn-red" catchtap="onUnpairDevice" data-index="{{index}}" data-item="{{item}}">
                    <text class="delete-icon">×</text>
                  </view>
              </view>
            </view>
          </block>
        </view>
      </view>

      <!-- 3. 添加设备 -->
      <view class="header-btn-item menu-trigger" catchtap="toggleAddDeviceDropdown">
        <view class="icon-btn">
          <image class="btn-icon-img" src="/images/icons/add.png" mode="aspectFit"></image>
        </view>
        <text class="btn-label">连接方式</text>

        <!-- 添加设备下拉菜单 -->
        <view class="dropdown-menu {{showAddDeviceDropdown ? 'show' : ''}}">
          <view class="dropdown-grid">
            <view class="dropdown-item" bind:tap="onActivateProduct">
              <text>激活设备</text>
            </view>
            <view class="dropdown-item" bind:tap="onApiTest">
              <text>蓝牙连接</text>
            </view>
          </view>
        </view>
      </view>
    </view>

    <!-- 综合显示框 (Consolidated Display) -->
    <view class="display-screen">
      <!-- 第一行：基本状态 -->
      <view class="display-row">
        <view class="display-item">
          <text class="display-label">A/C</text>
          <text class="display-value {{remoteState.powerOn ? 'active' : ''}}">{{remoteState.powerOn ? 'ON' : 'OFF'}}</text>
        </view>
        <view class="display-item">
          <text class="display-label">信号</text>
          <view class="display-item-content">
            <block wx:if="{{selectedDevice.connectionType === 'bluetooth'}}">
              <image class="display-connection-icon-small" src="/images/icons/bluetooth.png" mode="aspectFit" style="width:30rpx;height:30rpx;"></image>
            </block>
            <block wx:else>
              <view class="display-signal-bars-small">
                <view class="display-signal-bar {{selectedDevice.signalStrength >= 1 ? 'active' : ''}}"></view>
                <view class="display-signal-bar {{selectedDevice.signalStrength >= 2 ? 'active' : ''}}"></view>
                <view class="display-signal-bar {{selectedDevice.signalStrength >= 3 ? 'active' : ''}}"></view>
                <view class="display-signal-bar {{selectedDevice.signalStrength >= 4 ? 'active' : ''}}"></view>
                <view class="display-signal-bar {{selectedDevice.signalStrength >= 5 ? 'active' : ''}}"></view>
              </view>
            </block>
          </view>
        </view>
        <view class="display-item">
          <text class="display-label">状态</text>
          <text class="display-value nomal" wx:if="{{deviceStatus.online}}">在线</text>
          <text class="display-value" wx:else>离线</text>
        </view>
      </view>

      <!-- 中间：核心显示 (温度 & 模式) -->
      <view class="display-main">
        <!-- 左侧：故障码显示 -->
        <view class="display-item fault-status">
          <text class="display-label-mini">故障码</text>
          <text class="display-value fault-code {{deviceStatus.faultCode ? 'error' : 'nomal'}}">{{deviceStatus.faultCode || '--'}}</text>
        </view>
        <view class="display-item temp-display">
          <text class="temp-value">{{remoteState.targetTemperature || '--'}}</text>
          <text class="temp-unit">°C</text>
        </view>
        <view class="display-item mode-display">
          <text class="mode-text">{{remoteState.mode === 'auto' ? '制冷' : (remoteState.mode === 'strong' ? '强劲' : (remoteState.mode === 'eco' ? '节能' : (remoteState.mode === 'heat' ? '制热' : remoteState.mode === 'fan' ? '通风':'--')))}}</text>
        </view>
      </view>

      <!-- 第三行：环境信息 -->
      <view class="display-row">
        <view class="display-item">
          <text class="display-label">风速</text>
          <text class="display-value">{{remoteState.windSpeed+'档' || '--'}}</text>
        </view>
        <view class="display-item">
          <text class="display-label">出风温度</text>
          <text class="display-value">{{deviceStatus.outletTemp}}°C</text>
        </view>
        <view class="display-item">
          <text class="display-label">进风温度</text>
          <text class="display-value">{{deviceStatus.inletTemp}}°C</text>
        </view>
      </view>

      <!-- 第四行：更多状态 -->
      <view class="display-row">
        <view class="display-item">
          <text class="display-label">上下摆风</text>
          <text class="display-value {{remoteState.swingUpDown ? 'active' : ''}}">{{remoteState.swingUpDown ? 'ON' : 'OFF'}}</text>
        </view>
        <view class="display-item">
          <text class="display-label">左右摆风</text>
          <text class="display-value {{remoteState.swingLeftRight ? 'active' : ''}}">{{remoteState.swingLeftRight ? 'ON' : 'OFF'}}</text>
        </view>
        <view class="display-item">
          <text class="display-label">电压</text>
          <text class="display-value">{{deviceStatus.voltage}}V</text>
        </view>
      </view>

      <!-- 第五行：扩展功能状态 -->
      <view class="display-row">
        <view class="display-item">
          <text class="display-label">照明灯</text>
          <text class="display-value {{remoteState.lightingOn ? 'active' : ''}}">{{remoteState.lightingOn ? 'ON' : 'OFF'}}</text>
        </view>
        <view class="display-item">
          <text class="display-label">氛围灯</text>
          <text class="display-value {{remoteState.lightSurround ? 'active' : ''}}">{{remoteState.lightSurround ? 'ON' : 'OFF'}}</text>
        </view>
        <view class="display-item">
          <text class="display-label">负离子</text>
          <text class="display-value {{remoteState.lightClean ? 'active' : ''}}">{{remoteState.lightClean ? 'ON' : 'OFF'}}</text>
        </view>
      </view>
    </view>

    <!-- 中间控制区域 (Split Layout) -->
    <view class="control-panel-split">
      <!-- 左侧：风速控制 -->
      <view class="control-column">
        <view class="control-pill">
          <view class="control-btn" bindtap="increaseWindSpeed">
            <image class="control-icon-img" src="/images/icons/plus.png" mode="aspectFit"></image>
          </view>
          <view class="control-icon-area">
            <view class="control-title">风速</view>
          </view>
          <view class="control-btn" bindtap="decreaseWindSpeed">
            <image class="control-icon-img" src="/images/icons/minus.png" mode="aspectFit"></image>
          </view>
        </view>
      </view>

      <!-- 右侧：温度控制 -->
      <view class="control-column">
        <view class="control-pill">
          <view class="control-btn" bindtap="increaseTemperature">
            <image class="control-icon-img" src="/images/icons/plus.png" mode="aspectFit"></image>
          </view>
          <view class="control-icon-area">
            <view class="control-title">温度</view>
          </view>
          <view class="control-btn" bindtap="decreaseTemperature">
            <image class="control-icon-img" src="/images/icons/minus.png" mode="aspectFit"></image>
          </view>
        </view>
      </view>
    </view>

    <!-- 功能按钮区域 (Updated Single Row with Pull-out Buttons) -->
    <view class="function-area">
      <view class="func-grid-row">
        
        <!-- 1. 模式键 (Auto/Strong/Eco/Fan) -->
        <view class="func-btn-wrapper" catchtap="cycleMode" catchlongpress="toggleModeDropdown">
          <view class="func-btn circle {{remoteState.powerOn ? 'active' : ''}}">
            <image class="func-icon-img" src="/images/icons/{{remoteState.mode === 'strong' ? 'strong' : (remoteState.mode === 'eco' ? 'eco' : (remoteState.mode === 'fan' ? 'wind' : 'auto'))}}.png" mode="aspectFit"></image>
          </view>
          <text class="func-label">{{remoteState.mode === 'auto' ? '制冷' : (remoteState.mode === 'strong' ? '强劲' : (remoteState.mode === 'eco' ? '节能' : (remoteState.mode === 'fan' ? '通风' : '模式')))}}</text>
          
          <!-- Mode Expandable -->
          <view class="expand-menu {{showModeDropdown ? 'show' : ''}}">
             <view class="expand-item" catchtap="selectMode" data-mode="auto" style="--i:1">
               <view class="expand-btn-circle {{remoteState.mode === 'auto' ? 'active' : ''}}">
                 <image src="/images/icons/auto.png" mode="aspectFit"></image>
               </view>
               <text class="expand-text">制冷</text>
             </view>
             <view class="expand-item" catchtap="selectMode" data-mode="strong" style="--i:2">
               <view class="expand-btn-circle {{remoteState.mode === 'strong' ? 'active' : ''}}">
                 <image src="/images/icons/strong.png" mode="aspectFit"></image>
               </view>
               <text class="expand-text">强劲</text>
             </view>
             <view class="expand-item" catchtap="selectMode" data-mode="eco" style="--i:3">
               <view class="expand-btn-circle {{remoteState.mode === 'eco' ? 'active' : ''}}">
                 <image src="/images/icons/eco.png" mode="aspectFit"></image>
               </view>
               <text class="expand-text">节能</text>
             </view>
             <view class="expand-item" catchtap="selectMode" data-mode="fan" style="--i:4">
               <view class="expand-btn-circle {{remoteState.mode === 'fan' ? 'active' : ''}}">
                 <image src="/images/icons/wind.png" mode="aspectFit"></image>
               </view>
               <text class="expand-text">通风</text>
             </view>
          </view>
        </view>

        <!-- 2. 摆风键 (Up/Down, Left/Right) -->
        <view class="func-btn-wrapper" catchtap="cycleSwing" catchlongpress="toggleSwingDropdown">
          <view class="func-btn circle {{remoteState.powerOn && (remoteState.swingUpDown || remoteState.swingLeftRight) ? 'active' : ''}}">
            <image class="func-icon-img" src="{{(remoteState.swingUpDown && remoteState.swingLeftRight) ? '/images/icons/wind5.png' : (remoteState.swingLeftRight ? '/images/icons/sidetoside.png' : '/images/icons/uptodown.png')}}" mode="aspectFit"></image>
          </view>
          <text class="func-label">{{(remoteState.swingUpDown && remoteState.swingLeftRight) ? '全向摆风' : (remoteState.swingLeftRight ? '左右摆风' : (remoteState.swingUpDown ? '上下摆风' : '摆风'))}}</text>

          <!-- Swing Expandable -->
          <view class="expand-menu {{showSwingDropdown ? 'show' : ''}}">
             <view class="expand-item" catchtap="selectSwing" data-type="off" style="--i:1">
                <view class="expand-btn-circle {{(!remoteState.swingUpDown && !remoteState.swingLeftRight) ? 'active' : ''}}">
                  <image src="/images/icons/wind5.png" mode="aspectFit" style="opacity: 0.5;"></image>
                </view>
                <text class="expand-text">关闭</text>
             </view>
             <view class="expand-item" catchtap="selectSwing" data-type="ud" style="--i:2">
                <view class="expand-btn-circle {{remoteState.swingUpDown && !remoteState.swingLeftRight ? 'active' : ''}}">
                  <image src="/images/icons/uptodown.png" mode="aspectFit"></image>
                </view>
                <text class="expand-text">上下</text>
             </view>
             <view class="expand-item" catchtap="selectSwing" data-type="lr" style="--i:3">
                <view class="expand-btn-circle {{remoteState.swingLeftRight && !remoteState.swingUpDown ? 'active' : ''}}">
                  <image src="/images/icons/sidetoside.png" mode="aspectFit"></image>
                </view>
                <text class="expand-text">左右</text>
             </view>
             <view class="expand-item" catchtap="selectSwing" data-type="both" style="--i:4">
                <view class="expand-btn-circle {{remoteState.swingUpDown && remoteState.swingLeftRight ? 'active' : ''}}">
                  <image src="/images/icons/wind5.png" mode="aspectFit"></image>
                </view>
                <text class="expand-text">全向</text>
             </view>
          </view>
        </view>

        <!-- 3. 功能键 (Lighting/Surround/Anion) -->
        <view class="func-btn-wrapper" catchtap="cycleFunction" catchlongpress="toggleFunctionDropdown">
          <view class="func-btn circle {{remoteState.powerOn && (remoteState.lightingOn || remoteState.lightSurround || remoteState.lightClean) ? 'active' : ''}}">
            <image class="func-icon-img" src="/images/icons/Wrench.png" mode="aspectFit"></image>
          </view>
          <text class="func-label">功能</text>

          <!-- Function Expandable -->
          <view class="expand-menu {{showFunctionDropdown ? 'show' : ''}}">
             <view class="expand-item" catchtap="selectFunction" data-func="off" style="--i:1">
               <view class="expand-btn-circle">
                 <image src="/images/icons/light_off.png" mode="aspectFit"></image>
               </view>
               <text class="expand-text">全部关闭</text>
             </view>
             <view class="expand-item" catchtap="selectFunction" data-func="light" style="--i:2">
               <view class="expand-btn-circle {{remoteState.lightingOn ? 'active' : ''}}">
                 <image src="/images/icons/light_on.png" mode="aspectFit"></image>
               </view>
               <text class="expand-text">照明灯</text>
             </view>
             <view class="expand-item" catchtap="selectFunction" data-func="surround" style="--i:3">
               <view class="expand-btn-circle {{remoteState.lightSurround ? 'active' : ''}}">
                 <image src="/images/icons/sun.png" mode="aspectFit"></image>
               </view>
               <text class="expand-text">氛围灯</text>
             </view>
             <view class="expand-item" catchtap="selectFunction" data-func="clean" style="--i:4">
               <view class="expand-btn-circle {{remoteState.lightClean ? 'active' : ''}}">
                 <image src="/images/icons/eco.png" mode="aspectFit"></image>
               </view>
               <text class="expand-text">负离子</text>
             </view>
          </view>
        </view>

        <!-- 4. 定时 (Existing) -->
        <view class="func-btn-wrapper" bindtap="timerTest">
          <view class="func-btn circle {{(remoteState.powerOn && remoteState.clock) ? 'active' : ''}}" >
            <image class="func-icon-img" src="/images/icons/clock.png" mode="aspectFit"></image>
          </view>
          <text class="func-label">{{(remoteState.powerOn && wxTimerList.timerBtn.wxTimer) ? wxTimerList.timerBtn.wxTimer : '定时'}}</text>
        </view>
      </view>
    </view>

  <!-- 定时弹窗 -->
  <view wx:if="{{showTimerModal}}" class="timer-modal-overlay">
    <view class="timer-modal">
      <text class="timer-title">设置定时</text>

      <view class="timer-selected">{{formattedTimer}}</view>

      <view class="timer-controls">
        <view class="timer-btn-wrap" bindtap="changeTimer" data-delta="-30">
          <view class="timer-arrow">-</view>
          <text class="timer-tip">减少30分钟</text>
        </view>
        
        <view class="timer-btn-wrap" bindtap="changeTimer" data-delta="30">
          <view class="timer-arrow">+</view>
          <text class="timer-tip">增加30分钟</text>
        </view>
      </view>

      <view class="timer-actions">
        <button class="action-btn cancel" bindtap="closeTimerModal">取消</button>
        <button class="action-btn confirm" bindtap="confirmTimer">确定</button>
      </view>
    </view>
  </view>

  </view>

  <!-- 蓝牙搜索弹窗 -->
  <view wx:if="{{showBluetoothModal}}" class="bluetooth-modal-overlay">
    <view class="bluetooth-modal">
      <view class="modal-header">
        <text class="modal-title">发现蓝牙设备</text>
        <view class="close-btn" bindtap="closeBluetoothModal">×</view>
      </view>

      <view class="search-status">
        <block wx:if="{{isSearchingBluetooth}}">
          <view class="searching-spinner"></view>
          <text>正在搜索中... {{bluetoothSearchTimer}}s</text>
        </block>
        <block wx:else>
          <text>搜索结束</text>
        </block>
      </view>

      <scroll-view scroll-y class="bluetooth-list">
        <block wx:if="{{bluetoothDevices.length > 0}}">
          <view 
            class="bluetooth-item" 
            wx:for="{{bluetoothDevices}}" 
            wx:key="deviceId" 
            bindtap="connectToBluetooth" 
            data-id="{{item.deviceId}}"
          >
            <image class="bt-icon" src="/images/icons/bluetooth.png" mode="aspectFit"></image>
            <view class="bt-info">
              <text class="bt-name">{{item.name || item.localName || '未知设备'}}</text>
              <text class="bt-id">{{item.deviceId}}</text>
              <text class="bt-id">{{item.advertisServiceUUIDs}}</text>
            </view>
            <!-- <text class="bt-rssi">信号: {{item.RSSI}}</text> -->
          </view>
        </block>
        <view wx:elif="{{!isSearchingBluetooth}}" class="no-bt-devices">
          <text>附近未发现可用蓝牙设备</text>
        </view>
      </scroll-view>

      <view class="modal-footer">
        <button class="bt-action-btn refresh" bindtap="manualRefreshBluetooth">重新搜索</button>
        <button class="bt-action-btn close" bindtap="closeBluetoothModal">关闭</button>
      </view>
    </view>
  </view>
</view>

