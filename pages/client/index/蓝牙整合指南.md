# 蓝牙功能整合指南

## 问题诊断
当前 `index.js` 文件中存在以下问题：
1. 有多个重复的 `sendBluetoothCommand` 方法
2. 有未使用的 `madeCommand` 方法
3. `getBLECharacteristics` 方法没有启动数据监听

## 需要执行的修改步骤

### 步骤1: 删除无用的方法
删除以下方法（约1322-1341行）：
```javascript
madeCommand() {
  const buff = new ArrayBuffer(10)
  const dataView = new DataView(buffer);
  // ... 整个方法删除
}
```

### 步骤2: 删除重复的sendBluetoothCommand
文件中有3个sendBluetoothCommand方法，需要：
1. 保留第一个完整的实现（约1350-1637行，基于绿色图协议的版本）
2. 删除后面两个重复的版本

### 步骤3: 修改getBLECharacteristics方法
在 `getBLECharacteristics` 方法的success回调中添加启动监听：

```javascript
getBLECharacteristics(deviceId, serviceId) {
  wx.getBLEDeviceCharacteristics({
    deviceId,
    serviceId,
    success: (res) => {
      console.log('获取特征值成功', res.characteristics);
      const writeChar = res.characteristics.find(c => c.properties.write);
      const notifyChar = res.characteristics.find(c => c.properties.notify || c.properties.indicate);
      
      if (writeChar) {
        this.setData({ characteristicId: writeChar.uuid });
      }
      
      // 启动蓝牙数据监听
      if (notifyChar || writeChar) {
        console.log('[蓝牙] 启动数据监听');
        this.startBluetoothDataListener();
      }
    }
  });
},
```

### 步骤4: 确保startBluetoothDataListener方法存在
确认文件中有以下方法（应该在约1638-1692行）：

```javascript
/**
 * 启动蓝牙数据监听
 */
startBluetoothDataListener() {
  if (!this.data.isBluetoothConnected) return;

  wx.onBLECharacteristicValueChange((res) => {
    console.log('[蓝牙接收] 收到数据:', res);
    this.parseBluetoothData(res.value);
  });

  // 启用notify
  wx.notifyBLECharacteristicValueChange({
    deviceId: this.data.connectedDevice.deviceId,
    serviceId: this.data.serviceId,
    characteristicId: this.data.characteristicId,
    state: true,
    success: () => {
      console.log('[蓝牙接收] 数据监听已启动');
    },
    fail: (err) => {
      console.error('[蓝牙接收] 启动监听失败', err);
    }
  });
},
```

### 步骤5: 确保parseBluetoothData方法存在
确认文件中有以下方法（应该在约1481-1637行）：

```javascript
/**
 * 解析蓝牙接收到的数据（基于橙色图协议 - 显示屏发送到集控中心）
 * @param {ArrayBuffer} buffer - 接收到的数据包
 */
parseBluetoothData(buffer) {
  const dataView = new DataView(buffer);
  
  // 验证帧头
  if (dataView.getUint8(0) !== 0xAA || dataView.getUint8(1) !== 0xB4) {
    console.warn('[蓝牙接收] 无效的帧头');
    return null;
  }
  
  // ... 完整的解析逻辑
}
```

## 修改后的完整流程

1. 用户点击"接口测试" → `onApiTest()`
2. 打开蓝牙搜索弹窗 → `startBluetoothDiscovery()`
3. 用户点击设备连接 → `connectToBluetooth()`
4. 连接成功后获取服务 → `getBLEServices()`
5. 获取特征值 → `getBLECharacteristics()`
6. **启动数据监听** → `startBluetoothDataListener()` ← 新添加
7. 用户操作控制按钮 → `sendBluetoothCommand()` 发送指令
8. 设备返回数据 → `parseBluetoothData()` 解析并更新界面

## 验证清单

- [ ] 删除了 `madeCommand` 方法
- [ ] 只保留一个 `sendBluetoothCommand` 方法
- [ ] `getBLECharacteristics` 调用了 `startBluetoothDataListener()`
- [ ] `startBluetoothDataListener` 方法存在且完整
- [ ] `parseBluetoothData` 方法存在且完整
- [ ] 没有语法错误
- [ ] 没有重复的方法定义
