# 蓝牙功能修复方案

## 当前问题
文件中有3个 `sendBluetoothCommand` 方法定义：
- 第1个：1350行（完整的绿色图协议实现）✅ 保留
- 第2个：1622行（重复）❌ 删除
- 第3个：1853行（重复）❌ 删除

## 具体修复步骤

### 1. 删除第1322-1341行的madeCommand方法

找到并删除：
```javascript
madeCommand() {
  const buff = new ArrayBuffer(10)
  const dataView = new DataView(buffer);
  const remoteState = this.data.remoteState;
  //帧头固定
  dataView.setUint8(0, 0xAA);
  dataView.setUint8(1, 0x39);
  dataView.setUint8(2, 0x02);
  let data = [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00];
  const finalCommand = wx.getStorageSync('finalCommand', finalCommand);
  this.setPowerState(finalCommand),
    this.setTemp(finalCommand),
    this.setWindSpeed(finalCommand),
    this.setModel(finalCommand),
    this.setLight(finalCommand),
    this.setMoodLight(finalCommand),
    this.setIonizer(finalCommand),
    this.setSwing(finalCommand),
    this.setTimer(finalCommand)
},
```

### 2. 保留第1350行的sendBluetoothCommand（完整版本）

这个版本包含：
- 完整的协议实现
- 所有控制功能的switch-case
- 详细的调试日志

### 3. 删除第1622行开始的重复sendBluetoothCommand

这是第二个重复的方法定义，需要完全删除。

### 4. 删除第1853行开始的重复sendBluetoothCommand

这是第三个重复的方法定义，需要完全删除。

### 5. 修改getBLECharacteristics方法（约1308-1320行）

将：
```javascript
getBLECharacteristics(deviceId, serviceId) {
  wx.getBLEDeviceCharacteristics({
    deviceId,
    serviceId,
    success: (res) => {
      console.log('获取特征值成功', res.characteristics);
      const writeChar = res.characteristics.find(c => c.properties.write);
      if (writeChar) {
        this.setData({ characteristicId: writeChar.uuid });
      }
    }
  });
},
```

修改为：
```javascript
getBLECharacteristics(deviceId, serviceId) {
  wx.getBLEDeviceCharacteristics({
    deviceId,
    serviceId,
    success: (res) => {
      console.log('获取特征值成功', res.characteristics);
      const writeChar = res.characteristics.find(c => c.properties.write);
      const notifyChar = res.characteristics.find(c => c.properties.notify || c.properties.indicate);
      
      if (writeChar) {
        this.setData({ characteristicId: writeChar.uuid });
      }
      
      // 启动蓝牙数据监听
      if (notifyChar || writeChar) {
        console.log('[蓝牙] 启动数据监听');
        this.startBluetoothDataListener();
      }
    }
  });
},
```

## 修复后的文件结构

```
index.js
├── data: { ... }
├── onLoad()
├── ... 其他生命周期和方法
├── connectToBluetooth(e)        // 蓝牙连接
├── getBLEServices(deviceId)     // 获取服务
├── getBLECharacteristics()      // 获取特征值 + 启动监听 ← 修改
├── sendBluetoothCommand()       // 发送指令（保留第1个）
├── parseBluetoothData()         // 解析接收数据
├── startBluetoothDataListener() // 启动数据监听
└── })  // Page结束
```

## 快速修复命令（手动执行）

1. 打开 index.js
2. 搜索 "madeCommand" 并删除整个方法（约20行）
3. 搜索 "sendBluetoothCommand"，保留第一个，删除后面两个
4. 在 getBLECharacteristics 的 success 回调末尾添加监听启动代码
5. 保存文件

## 验证方法

修复后，在微信开发者工具中：
1. 检查是否有语法错误
2. 搜索 "sendBluetoothCommand" 应该只有2个结果：
   - 1个方法定义
   - 1个方法调用（在sendControlCommand中）
3. 编译通过即可
