<!--pages/client/feedback/feedback.wxml-->
<view class="feedback-container {{showBackupNav ? 'has-backup-nav' : ''}}">
  <wxs module="utils">
    // è¾…åŠ©å‡½æ•°
    var includes = function(arr, item) {
      return arr && arr.indexOf(item) > -1;
    }
    
    var getStatusText = function(status) {
      var map = {
        'pending': 'å¾…å¤„ç†',
        'assigned': 'å·²åˆ†é…',
        'processing': 'å¤„ç†ä¸­',
        'parts_sent': 'å¾…æ”¶ä»¶',
        'parts_received': 'å·²æ”¶ä»¶',
        'resolved': 'å·²å®Œæˆ',
        'closed': 'å·²å…³é—­',
        'cancelled': 'å·²å–æ¶ˆ'
      };
      return map[status] || 'æœªçŸ¥';
    };

    var formatTime = function(timestamp) {
      if (!timestamp) return '';
      var date = getDate(timestamp);
      var year = date.getFullYear();
      var month = (date.getMonth() + 1).toString();
      var day = date.getDate().toString();
      var hours = date.getHours().toString();
      var minutes = date.getMinutes().toString();
      
      if (month.length < 2) month = '0' + month;
      if (day.length < 2) day = '0' + day;
      if (hours.length < 2) hours = '0' + hours;
      if (minutes.length < 2) minutes = '0' + minutes;
      
      return year + '-' + month + '-' + day + ' ' + hours + ':' + minutes;
    };

    module.exports = {
      includes: includes,
      getStatusText: getStatusText,
      formatTime: formatTime
    };
  </wxs>
  <!-- å¤‡ç”¨å¯¼èˆªæ  - ä»…åœ¨ç‰¹æ®Šæƒ…å†µä¸‹æ˜¾ç¤º -->
  <view class="backup-navbar" wx:if="{{showBackupNav}}">
    <view class="nav-left" bindtap="onSmartBack">
      <text class="nav-icon">â†</text>
      <text class="nav-text">è¿”å›</text>
    </view>
    <view class="nav-center">
      <text class="nav-title">{{mode === 'view' ? 'é—®é¢˜è¯¦æƒ…' : 'å”®åç”³è¯·'}}</text>
    </view>
  </view>

  <!-- åˆ›å»ºæ¨¡å¼ -->
  <!-- åˆ›å»ºæ¨¡å¼ -->
  <view class="feedback-form" wx:if="{{mode === 'create'}}">
    
    <!-- å¤´éƒ¨ -->
    <view class="header-section">
      <view class="header-bg"></view>
      <view class="header-content">
        <view class="header-title">å”®åç”³è¯·</view>
        <view class="header-desc">è¯·æè¿°æ‚¨é‡åˆ°çš„é—®é¢˜ï¼Œæˆ‘ä»¬å°†å°½å¿«ä¸ºæ‚¨å¤„ç†</view>
      </view>
    </view>

    <view class="form-container">
      <!-- æ ¸å¿ƒä¿¡æ¯å¡ç‰‡ -->
      <view class="form-card">
        <view class="card-title">æ ¸å¿ƒä¿¡æ¯</view>
        
        <!-- äº§å“ç è¾“å…¥ -->
        <view class="form-group">
          <view class="form-label">
            <text>äº§å“è¯†åˆ«ç </text>
            <text class="option-mark">(é€‰å¡«)</text>
          </view>
          <view class="code-input-wrap">
            <input 
              class="form-input code-input" 
              type="text" 
              placeholder="è¯·è¾“å…¥äº§å“S/Nç " 
              placeholder-class="input-placeholder"
              value="{{formData.productCode}}" 
              bindinput="onProductCodeInput"
            />
            <button 
              class="scan-btn" 
              bindtap="onScanQRCode"
              hover-class="btn-hover"
            >
              <text class="scan-icon">ğŸ“·</text>
            </button>
          </view>
        </view>

        <!-- å¸¸è§æ•…éšœ -->
        <view class="form-group">
          <view class="form-label">
            <text>æ•…éšœç±»å‹</text>
            <text class="label-desc">(å¤šé€‰)</text>
          </view>
          <checkbox-group 
            class="fault-checkbox-group"
            bindchange="onFaultOptionsChange"
          >
            <label 
              class="fault-checkbox-item {{utils.includes(formData.faultTypes, item) ? 'checked' : ''}}" 
              wx:for="{{faultOptions}}" 
              wx:key="item"
            >
              <checkbox 
                class="fault-checkbox"
                value="{{item}}"
                checked="{{utils.includes(formData.faultTypes, item)}}"
              />
              <text class="fault-text">{{item}}</text>
            </label>
          </checkbox-group>
        </view>

        <!-- è¯¦ç»†æè¿° -->
        <view class="form-group no-border">
          <view class="form-label">
            <text>æ•…éšœæè¿°</text>
            <text class="label-desc">(å»ºè®®å¡«å†™)</text>
          </view>
          <view class="textarea-container">
            <textarea 
              class="form-textarea" 
              placeholder="è¯·æè¿°æ•…éšœç°è±¡ï¼Œä¾‹å¦‚ï¼šå¼€æœºæ— ååº”ã€åˆ¶å†·æ•ˆæœå·®ç­‰..." 
              placeholder-class="input-placeholder"
              value="{{formData.description}}" 
              bindinput="onDescriptionInput"
              maxlength="200"
            ></textarea>
            <view class="char-count">{{formData.description.length}}/200</view>
          </view>
        </view>
      </view>

      <!-- æ•…éšœå›¾ç‰‡å¡ç‰‡ -->
      <view class="form-card">
        <view class="card-title">æ•…éšœå›¾ç‰‡</view>
        <view class="form-group no-border">
          <view class="form-label">
            <text>ä¸Šä¼ ç…§ç‰‡</text>
            <text class="label-desc">(æœ€å¤š6å¼ )</text>
          </view>
          <view class="image-upload-area">
            <view 
              class="uploaded-item" 
              wx:for="{{formData.images}}" 
              wx:key="index"
            >
              <image 
                class="uploaded-img" 
                src="{{item}}" 
                mode="aspectFill"
                bindtap="onPreviewImage"
                data-url="{{item}}"
              ></image>
              <view 
                class="delete-btn" 
                catchtap="onDeleteImage"
                data-index="{{index}}"
              >
                <text class="delete-icon">Ã—</text>
              </view>
            </view>
            
            <view 
              class="upload-btn" 
              bindtap="onChooseImage"
              wx:if="{{formData.images.length < 6}}"
            >
              <view class="upload-icon-wrap">
                <text class="upload-icon">+</text>
              </view>
              <text class="upload-text">ä¸Šä¼ ç…§ç‰‡</text>
            </view>
          </view>
        </view>
      </view>

      <!-- è”ç³»ä¿¡æ¯å¡ç‰‡ -->
      <view class="form-card">
        <view class="card-title">è”ç³»ä¿¡æ¯</view>
        
        <!-- è”ç³»ç”µè¯ -->
        <view class="form-group">
          <view class="form-label">
            <text>è”ç³»ç”µè¯</text>
            <text class="required-mark">*</text>
          </view>
          <input 
            class="form-input" 
            type="number" 
            placeholder="è¯·è¾“å…¥æœ‰æ•ˆæ‰‹æœºå·" 
            placeholder-class="input-placeholder"
            value="{{formData.contactPhone}}" 
            bindinput="onContactPhoneInput"
            maxlength="11"
          />
        </view>

        <!-- æœåŠ¡åœ°å€ -->
        <view class="form-group no-border">
          <view class="form-label">
            <text>æœåŠ¡åœ°å€</text>
            <text class="required-mark">*</text>
          </view>
          
          <view class="location-selector-wrapper" bindtap="onGetLocation">
            <view class="location-picker">
              <text class="location-text">{{formData.fullLocation || 'ç‚¹å‡»è·å–å½“å‰ä½ç½®'}}</text>
              <text class="location-icon">ğŸ“</text>
            </view>
          </view>
          
          <view class="location-detail-wrapper">
            <input 
              class="form-input" 
              type="text" 
              placeholder="è¯¦ç»†åœ°å€ï¼ˆå¦‚ï¼šé“è·¯/é—¨ç‰Œå·ï¼‰" 
              placeholder-class="input-placeholder"
              value="{{formData.locationDetail}}" 
              bindinput="onLocationDetailInput"
            />
          </view>
        </view>
      </view>

      <!-- æäº¤æŒ‰é’® -->
      <view class="submit-area">
        <button 
          class="btn-submit" 
          hover-class="btn-hover"
          bindtap="onSubmit"
          disabled="{{!canSubmit || isSubmitting}}"
        >
          {{isSubmitting ? 'æäº¤ä¸­...' : 'æäº¤ç”³è¯·'}}
        </button>
      </view>
    </view>
  </view>

  <!-- æŸ¥çœ‹æ¨¡å¼ -->
  <view class="issue-detail" wx:if="{{mode === 'view'}}">

    <!-- çŠ¶æ€æ¦‚è§ˆå¡ç‰‡ -->
    <view class="status-card status-{{feedbackDetail.status}}">
      <view class="status-header">
        <text class="status-title">{{utils.getStatusText(feedbackDetail.status)}}</text>
        <text class="status-time">{{utils.formatTime(feedbackDetail.createTime)}}</text>
      </view>
      <view class="status-desc" wx:if="{{feedbackDetail.status === 'resolved'}}">
        æ‚¨çš„å·¥å•å·²å¤„ç†å®Œæˆï¼Œè¯·å¯¹æœ¬æ¬¡æœåŠ¡è¿›è¡Œè¯„ä»·ã€‚
      </view>
      <view class="status-desc" wx:elif="{{feedbackDetail.status === 'pending'}}">
        æ­£åœ¨ä¸ºæ‚¨å®‰æ’æœåŠ¡äººå‘˜ï¼Œè¯·ä¿æŒç”µè¯ç•…é€šã€‚
      </view>
    </view>

    <!-- å·¥å•è¯¦æƒ… -->
    <view class="section">
      <view class="section-title">å·¥å•è¯¦æƒ…</view>
      <view class="info-item">
        <text class="label">å·¥å•ç¼–å·</text>
        <text class="value copyable" bindtap="onCopy" data-text="{{feedbackDetail.issueId}}">{{feedbackDetail.issueId}} ğŸ“‹</text>
      </view>
      <view class="info-item">
        <text class="label">äº§å“ä¿¡æ¯</text>
        <text class="value">{{feedbackDetail.productModel || 'æœªçŸ¥å‹å·'}} ({{feedbackDetail.productCode || 'æ— ç '}})</text>
      </view>
      <view class="info-item">
        <text class="label">æ•…éšœç±»å‹</text>
        <text class="value">{{feedbackDetail.faultTypes}}</text>
      </view>
      <view class="info-item column-layout">
        <text class="label">æ•…éšœæè¿°</text>
        <text class="value description-text">{{feedbackDetail.description}}</text>
      </view>
      
      <!-- å›¾ç‰‡å±•ç¤º -->
      <view class="info-item column-layout" wx:if="{{feedbackDetail.imageUrls && feedbackDetail.imageUrls.length > 0}}">
        <text class="label">æ•…éšœå›¾ç‰‡</text>
        <view class="images">
          <image 
            wx:for="{{feedbackDetail.imageUrls}}" 
            wx:key="index"
            src="{{item}}" 
            class="image"
            mode="aspectFill"
            bindtap="onPreviewImage"
            data-src="{{item}}"
          />
        </view>
      </view>
    </view>

    <!-- è¿›åº¦è¿½è¸ª -->
    <view class="section">
      <view class="section-title">å¤„ç†è¿›åº¦</view>
      <view class="timeline">
        <!-- å€’åºå±•ç¤ºå†å²è®°å½• -->
        <view 
          class="timeline-item" 
          wx:for="{{history}}" 
          wx:key="index"
        >
          <view class="timeline-dot"></view>
          <view class="timeline-content">
            <view class="timeline-header">
              <text class="timeline-status">{{utils.getStatusText(item.status)}}</text>
              <text class="timeline-time">{{utils.formatTime(item.createTime || item.timestamp)}}</text>
            </view>
            <text class="timeline-remark" wx:if="{{item.remark}}">{{item.remark}}</text>
            <text class="timeline-operator" wx:if="{{item.operatorName}}">æ“ä½œäºº: {{item.operatorName}}</text>
          </view>
        </view>
      </view>
    </view>

    <!-- åº•éƒ¨æ“ä½œæ  -->
    <view class="bottom-actions" wx:if="{{feedbackDetail.status === 'pending'}}">
      <button class="btn-cancel" bindtap="onCancelIssue" disabled="{{isCancelling}}">å–æ¶ˆå·¥å•</button>
    </view>
    
  </view>
</view>
