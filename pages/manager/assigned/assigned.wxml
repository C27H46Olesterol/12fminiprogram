<!--pages/manager/assigned/assigned.wxml-->
<view class="container">
  <!-- å¤´éƒ¨ -->
  <view class="header">
    <text class="title">å·²åˆ†é…ä»»åŠ¡</text>
    <text class="count">å…± {{total}} ä¸ªä»»åŠ¡</text>
    <view class="header-actions">
      <button wx:if="{{!isEditMode}}" class="btn-edit-mode" size="mini" bindtap="toggleEditMode">ç®¡ç†</button>
      <button wx:if="{{isEditMode}}" class="btn-cancel" size="mini" bindtap="cancelEdit">å–æ¶ˆ</button>
      <button wx:if="{{isEditMode && selectedIssues.length > 0}}" class="btn-delete-batch" size="mini" bindtap="batchDelete">åˆ é™¤({{selectedIssues.length}})</button>
    </view>
  </view>

  <!-- ç­›é€‰å™¨ -->
  <view class="filter-section">
    <picker mode="selector" range="{{workers}}" range-key="name" bindchange="onWorkerChange">
      <view class="filter-item">
        <text class="filter-label">ç»´ä¿®å·¥:</text>
        <text class="filter-value">{{selectedWorkerId ? workers[selectedWorkerIndex].name : 'å…¨éƒ¨'}}</text>
      </view>
    </picker>

    <picker mode="selector" range="{{statuses}}" range-key="label" bindchange="onStatusChange">
      <view class="filter-item">
        <text class="filter-label">çŠ¶æ€:</text>
        <text class="filter-value">{{selectedStatus ? statuses[selectedStatusIndex].label : 'å…¨éƒ¨'}}</text>
      </view>
    </picker>
  </view>

  <!-- ä»»åŠ¡åˆ—è¡¨ -->
  <scroll-view class="issues-list" scroll-y bindscrolltolower="loadMore" lower-threshold="100">
    <view wx:if="{{issues.length > 0}}">
      <view class="issue-card {{isEditMode ? 'edit-mode' : ''}}" wx:for="{{issues}}" wx:key="_id">
        <!-- é€‰æ‹©æ¡†ï¼ˆç¼–è¾‘æ¨¡å¼ä¸‹æ˜¾ç¤ºï¼‰ -->
        <view wx:if="{{isEditMode}}" class="checkbox-wrapper" catchtap="toggleSelect" data-id="{{item._id}}" data-index="{{index}}">
          <view class="custom-checkbox {{item.selected ? 'checked' : ''}}">
            <text wx:if="{{item.selected}}" class="checkmark">âœ“</text>
          </view>
        </view>
        
        <!-- é—®é¢˜å†…å®¹ -->
        <view class="issue-content" bindtap="{{isEditMode ? '' : 'viewDetail'}}" data-id="{{item._id}}">
          <!-- ä»»åŠ¡å¤´éƒ¨ -->
          <view class="issue-header">
            <text class="issue-title">{{item.title}}</text>
            <view class="status-badge status-{{item.status}}">
              {{item.status === 'assigned' ? 'å·²åˆ†é…' : item.status === 'processing' ? 'å¤„ç†ä¸­' : item.status === 'parts_request' ? 'é…ä»¶ç”³è¯·ä¸­' : item.status === 'parts_sent' ? 'é…ä»¶å·²å‘å‡º' : item.status === 'parts_return_approval' ? 'å¾…å®¡æ‰¹' : item.status === 'parts_received' ? 'è¿”ä»¶å·²æ”¶åˆ°' : item.status === 'cancelled' ? 'å·²å–æ¶ˆ' : 'å¤„ç†ä¸­'}}
            </view>
          </view>

        <!-- é—®é¢˜æè¿° -->
        <text class="issue-description">{{item.description}}</text>

        <!-- ä»»åŠ¡ä¿¡æ¯ -->
        <view class="issue-info">
          <view class="info-item">
            <text class="info-label">åˆ†ç±»:</text>
            <text class="info-value">{{item.category}}</text>
          </view>
          <view class="info-item">
            <text class="info-label">ä¼˜å…ˆçº§:</text>
            <text class="info-value priority-{{item.priority}}">{{item.priority === 'urgent' ? 'ç´§æ€¥' : item.priority === 'high' ? 'é«˜' : item.priority === 'medium' ? 'ä¸­' : 'ä½'}}</text>
          </view>
        </view>

        <!-- ç»´ä¿®å·¥ä¿¡æ¯ -->
        <view class="worker-info">
          <text class="worker-label">ç»´ä¿®å·¥:</text>
          <text class="worker-name">{{item.assignedWorkerName}}</text>
          <text class="worker-phone">{{item.assignedWorkerPhone}}</text>
          <text class="assign-time">{{item.assignedTime}}</text>
        </view>

        <!-- è®¾å¤‡ä¿¡æ¯ -->
        <view class="device-info">
          <text class="device-label">è®¾å¤‡:</text>
          <text class="device-name">{{item.deviceName || 'æœªçŸ¥è®¾å¤‡'}}</text>
        </view>

          <!-- æ“ä½œæŒ‰é’® -->
          <view class="actions" wx:if="{{!isEditMode}}">
            <!-- å·²åˆ†é…çŠ¶æ€ï¼šå¼€å§‹å¤„ç† -->
            <button wx:if="{{item.status === 'assigned'}}" class="btn-start" size="mini" catchtap="startProcessing" data-id="{{item._id}}">
              å¼€å§‹å¤„ç†
            </button>
            
            <!-- å¤„ç†ä¸­ä¸”éœ€è¦é…ä»¶ï¼šå‘å‡ºé…ä»¶ -->
            <button wx:if="{{item.status === 'processing' && item.needParts}}" class="btn-send-parts" size="mini" catchtap="sendParts" data-id="{{item._id}}">
              å‘å‡ºé…ä»¶
            </button>
            
            <!-- é…ä»¶ç”³è¯·ä¸­ï¼šç­‰å¾…ä¸»ç®¡å®¡æ‰¹ -->
            <button wx:if="{{item.status === 'parts_request'}}" class="btn-approval" size="mini" catchtap="viewDetail" data-id="{{item._id}}">
              é…ä»¶å®¡æ‰¹
            </button>
            
            <!-- é…ä»¶å·²å‘å‡ºï¼šå‘å‡ºè¿”ä»¶ -->
            <button wx:if="{{item.status === 'parts_sent'}}" class="btn-return-parts" size="mini" catchtap="returnParts" data-id="{{item._id}}">
              å‘å‡ºè¿”ä»¶
            </button>
            
            <!-- è¿”ä»¶å·²æ”¶åˆ°ï¼šå®Œæˆä»»åŠ¡å’ŒæŸ¥çœ‹è¯¦æƒ…ï¼ˆåŒ…å«å¾…å®¡æ‰¹çŠ¶æ€ï¼Œç›´æ¥è·³è¿‡å®¡æ‰¹ï¼‰ -->
            <button wx:if="{{item.status === 'parts_received' || item.status === 'parts_return_approval'}}" class="btn-complete" size="mini" catchtap="completeTask" data-id="{{item._id}}">
              å®Œæˆä»»åŠ¡
            </button>
            <button wx:if="{{item.status === 'parts_received' || item.status === 'parts_return_approval'}}" class="btn-detail" size="mini" catchtap="viewDetail" data-id="{{item._id}}">
              æŸ¥çœ‹è¯¦æƒ…
            </button>
            
            <!-- å¤„ç†ä¸­ä¸”ä¸éœ€è¦é…ä»¶ï¼šå®Œæˆä»»åŠ¡ -->
            <button wx:if="{{item.status === 'processing' && !item.needParts}}" class="btn-complete" size="mini" catchtap="completeTask" data-id="{{item._id}}">
              å®Œæˆä»»åŠ¡
            </button>
            
            <!-- æŸ¥çœ‹è¯¦æƒ…æŒ‰é’®ï¼ˆæ‰€æœ‰çŠ¶æ€ï¼Œä½†è¿”ä»¶å·²æ”¶åˆ°å’Œè¿”ä»¶å¾…å®¡æ‰¹çŠ¶æ€å·²æœ‰ä¸“é—¨æŒ‰é’®ï¼‰ -->
            <button wx:if="{{item.status !== 'parts_received' && item.status !== 'parts_return_approval'}}" class="btn-detail" size="mini" catchtap="viewDetail" data-id="{{item._id}}">
              æŸ¥çœ‹è¯¦æƒ…
            </button>
            
            <!-- å‘é€æé†’æŒ‰é’®ï¼ˆå·²åˆ†é…çŠ¶æ€ï¼‰ -->
            <button wx:if="{{item.status === 'assigned'}}" class="btn-reminder" size="mini" catchtap="sendReminder" data-issue="{{item}}">
              å‘é€æé†’
            </button>
          </view>
          
          <!-- å•ç‹¬åˆ é™¤æŒ‰é’®ï¼ˆç¼–è¾‘æ¨¡å¼ä¸‹ï¼‰ -->
          <view class="actions" wx:if="{{isEditMode}}">
            <button class="btn-delete-single" size="mini" catchtap="deleteSingle" data-id="{{item._id}}">
              åˆ é™¤
            </button>
          </view>
        </view>
      </view>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view wx:if="{{!isLoading && issues.length === 0}}" class="empty-state">
      <view class="empty-icon">ğŸ“‹</view>
      <text class="empty-text">æš‚æ— å·²åˆ†é…ä»»åŠ¡</text>
    </view>

    <!-- åŠ è½½çŠ¶æ€ -->
    <view wx:if="{{isLoading}}" class="loading-state">
      <text>åŠ è½½ä¸­...</text>
    </view>

    <!-- åŠ è½½æ›´å¤š -->
    <view wx:if="{{!isLoading && hasMore && issues.length > 0}}" class="load-more">
      <text>ä¸Šæ‹‰åŠ è½½æ›´å¤š</text>
    </view>

    <!-- æ²¡æœ‰æ›´å¤š -->
    <view wx:if="{{!hasMore && issues.length > 0}}" class="no-more">
      <text>æ²¡æœ‰æ›´å¤šäº†</text>
    </view>
  </scroll-view>
</view>