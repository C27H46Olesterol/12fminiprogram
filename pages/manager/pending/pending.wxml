<!--pages/manager/pending/pending.wxml-->
<view class="container">
  <!-- å¤´éƒ¨ -->
  <view class="header">
    <text class="title">å¾…å¤„ç†é—®é¢˜</text>
    <text class="count">å…± {{total}} ä¸ªé—®é¢˜</text>
    <view class="header-actions">
      <button wx:if="{{!isEditMode}}" class="btn-edit-mode" size="mini" bindtap="toggleEditMode">ç®¡ç†</button>
      <button wx:if="{{isEditMode}}" class="btn-cancel" size="mini" bindtap="cancelEdit">å–æ¶ˆ</button>
      <button wx:if="{{isEditMode && selectedIssues.length > 0}}" class="btn-delete-batch" size="mini" bindtap="batchDelete">åˆ é™¤({{selectedIssues.length}})</button>
    </view>
  </view>

  <!-- ç­›é€‰ç±»å‹æŒ‰é’® -->
  <view class="filter-tabs">
    <view 
      wx:for="{{filterTypes}}" 
      wx:key="value" 
      class="filter-tab {{filterType === item.value ? 'active' : ''}}"
      bindtap="onFilterTypeChange"
      data-type="{{item.value}}"
    >
      {{item.label}}
      <view wx:if="{{item.count > 0}}" class="tab-badge">{{item.count}}</view>
    </view>
  </view>

  <!-- ç­›é€‰å™¨ -->
  <view class="filter-section">
    <picker mode="selector" range="{{categories}}" value="{{selectedCategory}}" bindchange="onCategoryChange">
      <view class="filter-item">
        <text class="filter-label">åˆ†ç±»:</text>
        <text class="filter-value">{{selectedCategory || 'å…¨éƒ¨'}}</text>
      </view>
    </picker>

    <picker mode="selector" range="{{priorities}}" range-key="label" bindchange="onPriorityChange">
      <view class="filter-item">
        <text class="filter-label">ä¼˜å…ˆçº§:</text>
        <text class="filter-value">{{selectedPriority ? priorities[selectedPriority].label : 'å…¨éƒ¨'}}</text>
      </view>
    </picker>
  </view>

  <!-- é—®é¢˜åˆ—è¡¨ -->
  <scroll-view class="issues-list" scroll-y bindscrolltolower="loadMore" lower-threshold="100">
    <view wx:if="{{issues.length > 0}}">
      <view class="issue-card {{isEditMode ? 'edit-mode' : ''}}" wx:for="{{issues}}" wx:key="_id">
        <!-- é€‰æ‹©æ¡†ï¼ˆç¼–è¾‘æ¨¡å¼ä¸‹æ˜¾ç¤ºï¼‰ -->
        <view wx:if="{{isEditMode}}" class="checkbox-wrapper" catchtap="toggleSelect" data-id="{{item._id}}" data-index="{{index}}">
          <view class="custom-checkbox {{item.selected ? 'checked' : ''}}">
            <text wx:if="{{item.selected}}" class="checkmark">âœ“</text>
          </view>
        </view>
        
        <!-- é—®é¢˜å†…å®¹ï¼ˆéç¼–è¾‘æ¨¡å¼ä¸‹å¯ç‚¹å‡»ï¼‰ -->
        <view class="issue-content" bindtap="{{isEditMode ? '' : 'viewDetail'}}" data-id="{{item._id}}">
      <!-- é—®é¢˜ç¼–å· -->
      <view class="issue-number">
        <text class="number-label">ç¼–å·:</text>
        <text class="number-value">{{item.issueId}}</text>
      </view>
          
          <!-- é—®é¢˜æ ‡é¢˜ -->
          <view class="issue-header">
            <text class="issue-title">{{item.title}}</text>
            <view class="priority-badge priority-{{item.priority}}">
              {{item.priority === 'urgent' ? 'ç´§æ€¥' : item.priority === 'high' ? 'é«˜' : item.priority === 'medium' ? 'ä¸­' : 'ä½'}}
            </view>
          </view>

        <!-- é—®é¢˜æè¿° -->
        <text class="issue-description">{{item.description}}</text>

        <!-- é—®é¢˜ä¿¡æ¯ -->
        <view class="issue-info">
          <view class="info-item">
            <text class="info-label">åˆ†ç±»:</text>
            <text class="info-value">{{item.category}}</text>
          </view>
          <view class="info-item">
            <text class="info-label">è®¾å¤‡:</text>
            <text class="info-value">{{item.deviceName || 'æœªçŸ¥è®¾å¤‡'}}</text>
          </view>
        </view>

        <!-- æŠ¥å‘Šäººä¿¡æ¯ï¼ˆå¾…åˆ†é…ä»»åŠ¡æ—¶æ˜¾ç¤ºï¼‰ -->
        <view class="reporter-info" wx:if="{{filterType === 'pending'}}">
          <text class="reporter-label">æŠ¥å‘Šäºº:</text>
          <text class="reporter-name">{{item.reporterName}}</text>
          <text class="reporter-phone">{{item.reporterPhone}}</text>
          <text class="report-time">{{item.createTime}}</text>
        </view>

        <!-- ç»´ä¿®å·¥ä¿¡æ¯ï¼ˆéå¾…åˆ†é…ä»»åŠ¡æ—¶æ˜¾ç¤ºï¼‰ -->
        <view class="worker-info" wx:if="{{filterType !== 'pending'}}">
          <text class="worker-label">ç»´ä¿®å·¥:</text>
          <text class="worker-name">{{item.assignedWorkerName}}</text>
          <text class="worker-phone">{{item.assignedWorkerPhone}}</text>
          <text class="assign-time">{{item.assignedTime}}</text>
        </view>

          <!-- æ“ä½œæŒ‰é’® -->
          <view class="actions" wx:if="{{!isEditMode}}">
            <!-- å¾…åˆ†é…ä»»åŠ¡ï¼šåˆ†é…ä»»åŠ¡å’ŒæŸ¥çœ‹è¯¦æƒ… -->
            <block wx:if="{{filterType === 'pending'}}">
              <button class="btn-assign" size="mini" catchtap="assignIssue" data-id="{{item._id}}">
                åˆ†é…ä»»åŠ¡
              </button>
              <button class="btn-detail" size="mini" catchtap="viewDetail" data-id="{{item._id}}">
                æŸ¥çœ‹è¯¦æƒ…
              </button>
            </block>

            <!-- å¤„ç†ä¸­ï¼šæ ¹æ®çŠ¶æ€æ˜¾ç¤ºä¸åŒæ“ä½œæŒ‰é’® -->
            <block wx:if="{{filterType === 'processing'}}">
              <!-- assignedçŠ¶æ€ï¼šæ˜¾ç¤ºå¼€å§‹å¤„ç† -->
              <button wx:if="{{item.status === 'assigned'}}" class="btn-start" size="mini" catchtap="startProcessing" data-id="{{item._id}}">
                å¼€å§‹å¤„ç†
              </button>
              
              <!-- processingçŠ¶æ€ä¸”éœ€è¦é…ä»¶ï¼šæ˜¾ç¤ºå‘å‡ºé…ä»¶ -->
              <button wx:if="{{item.status === 'processing' && item.needParts}}" class="btn-send-parts" size="mini" catchtap="sendParts" data-id="{{item._id}}">
                å‘å‡ºé…ä»¶
              </button>
              
              <!-- processingçŠ¶æ€ä¸”ä¸éœ€è¦é…ä»¶ï¼šæ˜¾ç¤ºå®Œæˆä»»åŠ¡ -->
              <button wx:if="{{item.status === 'processing' && !item.needParts}}" class="btn-complete" size="mini" catchtap="completeTask" data-id="{{item._id}}">
                å®Œæˆä»»åŠ¡
              </button>
              
              <!-- æŸ¥çœ‹è¯¦æƒ…æŒ‰é’® -->
              <button class="btn-detail" size="mini" catchtap="viewDetail" data-id="{{item._id}}">
                æŸ¥çœ‹è¯¦æƒ…
              </button>
            </block>

            <!-- å¾…å‘ä»¶ï¼šå‘å‡ºé…ä»¶å’ŒæŸ¥çœ‹è¯¦æƒ… -->
            <block wx:if="{{filterType === 'parts_request'}}">
              <button class="btn-send-parts" size="mini" catchtap="sendParts" data-id="{{item._id}}">
                å‘å‡ºé…ä»¶
              </button>
              <button class="btn-detail" size="mini" catchtap="viewDetail" data-id="{{item._id}}">
                æŸ¥çœ‹è¯¦æƒ…
              </button>
            </block>

            <!-- å¾…è¿”ä»¶ï¼šå‘å‡ºè¿”ä»¶å’ŒæŸ¥çœ‹è¯¦æƒ… -->
            <block wx:if="{{filterType === 'parts_sent'}}">
              <button class="btn-return-parts" size="mini" catchtap="returnParts" data-id="{{item._id}}">
                å‘å‡ºè¿”ä»¶
              </button>
              <button class="btn-detail" size="mini" catchtap="viewDetail" data-id="{{item._id}}">
                æŸ¥çœ‹è¯¦æƒ…
              </button>
            </block>

            <!-- å¾…å®Œæˆï¼šå®Œæˆä»»åŠ¡å’ŒæŸ¥çœ‹è¯¦æƒ… -->
            <block wx:if="{{filterType === 'parts_received'}}">
              <button class="btn-complete" size="mini" catchtap="completeTask" data-id="{{item._id}}">
                å®Œæˆä»»åŠ¡
              </button>
              <button class="btn-detail" size="mini" catchtap="viewDetail" data-id="{{item._id}}">
                æŸ¥çœ‹è¯¦æƒ…
              </button>
            </block>
          </view>
          
          <!-- å•ç‹¬åˆ é™¤æŒ‰é’®ï¼ˆç¼–è¾‘æ¨¡å¼ä¸‹ï¼‰ -->
          <view class="actions" wx:if="{{isEditMode}}">
            <button class="btn-delete-single" size="mini" catchtap="deleteSingle" data-id="{{item._id}}">
              åˆ é™¤
            </button>
          </view>
        </view>
      </view>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view wx:if="{{!isLoading && issues.length === 0}}" class="empty-state">
      <view class="empty-icon">ğŸ“‹</view>
      <text class="empty-text">æš‚æ— å¾…å¤„ç†é—®é¢˜</text>
    </view>

    <!-- åŠ è½½çŠ¶æ€ -->
    <view wx:if="{{isLoading}}" class="loading-state">
      <text>åŠ è½½ä¸­...</text>
    </view>

    <!-- åŠ è½½æ›´å¤š -->
    <view wx:if="{{!isLoading && hasMore && issues.length > 0}}" class="load-more">
      <text>ä¸Šæ‹‰åŠ è½½æ›´å¤š</text>
    </view>

    <!-- æ²¡æœ‰æ›´å¤š -->
    <view wx:if="{{!hasMore && issues.length > 0}}" class="no-more">
      <text>æ²¡æœ‰æ›´å¤šäº†</text>
    </view>
  </scroll-view>

  <!-- åˆ†é…ç»´ä¿®å·¥å¼¹çª— -->
  <view class="modal" wx:if="{{showAssignModal}}">
    <view class="modal-content">
      <view class="modal-header">
        <text class="modal-title">åˆ†é…ç»´ä¿®å·¥</text>
        <text class="modal-close" bindtap="onHideAssignModal">Ã—</text>
      </view>
      <view class="modal-body">
        <!-- æœç´¢æ¡† -->
        <view class="search-box">
          <input 
            class="search-input" 
            placeholder="æœç´¢ç»´ä¿®å·¥å§“åæˆ–æ‰‹æœºå·" 
            value="{{workerSearchKeyword}}"
            bindinput="onWorkerSearch"
            placeholder-class="search-placeholder"
          />
          <text class="search-icon">ğŸ”</text>
        </view>
        
        <!-- ç»´ä¿®å·¥åˆ—è¡¨ -->
        <view class="worker-list">
          <view 
            wx:for="{{filteredWorkers}}" 
            wx:key="_id"
            class="worker-item {{selectedWorkerId === item._id ? 'selected' : ''}}"
            bindtap="onSelectWorker"
            data-id="{{item._id}}"
            data-index="{{index}}"
          >
            <view class="worker-info-row">
              <text class="worker-name">{{item.nickname}}</text>
              <view wx:if="{{item.averageRating > 0}}" class="worker-rating">
                <text class="rating-star">â˜…</text>
                <text class="rating-value">{{item.averageRating}}</text>
                <text class="rating-count">({{item.ratingCount}})</text>
              </view>
              <text wx:else class="no-rating">æš‚æ— è¯„ä»·</text>
            </view>
            <view wx:if="{{item.phone}}" class="worker-phone">{{item.phone}}</view>
            <!-- æ˜¾ç¤ºè·ç¦»ä¿¡æ¯ -->
            <view wx:if="{{item.distance}}" class="worker-distance">
              <text class="distance-icon">ğŸ“</text>
              <text class="distance-text">è·ç¦»ï¼š{{item.distance}}</text>
            </view>
            <!-- æ˜¾ç¤ºåœ°å€ä¿¡æ¯ -->
            <view wx:if="{{item.region}}" class="worker-address">
              <text class="address-text">{{item.region}}</text>
            </view>
          </view>
          
          <!-- æ— æœç´¢ç»“æœæç¤º -->
          <view wx:if="{{filteredWorkers.length === 0}}" class="no-result">
            <text class="no-result-text">æœªæ‰¾åˆ°åŒ¹é…çš„ç»´ä¿®å·¥</text>
          </view>
        </view>
      </view>
      <view class="modal-footer">
        <button class="btn secondary" bindtap="onHideAssignModal">å–æ¶ˆ</button>
        <button class="btn primary" bindtap="onConfirmAssign">ç¡®è®¤</button>
      </view>
    </view>
  </view>
</view>
