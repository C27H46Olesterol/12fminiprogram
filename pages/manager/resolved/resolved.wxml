<!--pages/manager/resolved/resolved.wxml-->
<view class="container">
  <!-- å¤´éƒ¨ -->
  <view class="header">
    <text class="title">å·²è§£å†³é—®é¢˜</text>
    <text class="count">å…± {{total}} ä¸ªé—®é¢˜</text>
    <view class="header-actions">
      <button wx:if="{{!isEditMode}}" class="btn-edit-mode" size="mini" bindtap="toggleEditMode">ç®¡ç†</button>
      <button wx:if="{{isEditMode}}" class="btn-cancel" size="mini" bindtap="cancelEdit">å–æ¶ˆ</button>
      <button wx:if="{{isEditMode && selectedIssues.length > 0}}" class="btn-delete-batch" size="mini" bindtap="batchDelete">åˆ é™¤({{selectedIssues.length}})</button>
    </view>
  </view>

  <!-- ç­›é€‰å™¨ -->
  <view class="filter-section">
    <picker mode="selector" range="{{workers}}" range-key="name" bindchange="onWorkerChange">
      <view class="filter-item">
        <text class="filter-label">ç»´ä¿®å·¥:</text>
        <text class="filter-value">{{selectedWorkerId ? workers[selectedWorkerIndex].name : 'å…¨éƒ¨'}}</text>
      </view>
    </picker>

    <picker mode="date" bindchange="onDateChange">
      <view class="filter-item">
        <text class="filter-label">æ—¥æœŸ:</text>
        <text class="filter-value">{{selectedDate || 'å…¨éƒ¨'}}</text>
      </view>
    </picker>
  </view>

  <!-- é—®é¢˜åˆ—è¡¨ -->
  <scroll-view class="issues-list" scroll-y bindscrolltolower="loadMore" lower-threshold="100">
    <view wx:if="{{issues.length > 0}}">
      <view class="issue-card {{isEditMode ? 'edit-mode' : ''}}" wx:for="{{issues}}" wx:key="_id">
        <!-- é€‰æ‹©æ¡†ï¼ˆç¼–è¾‘æ¨¡å¼ä¸‹æ˜¾ç¤ºï¼‰ -->
        <view wx:if="{{isEditMode}}" class="checkbox-wrapper" catchtap="toggleSelect" data-id="{{item._id}}" data-index="{{index}}">
          <view class="custom-checkbox {{item.selected ? 'checked' : ''}}">
            <text wx:if="{{item.selected}}" class="checkmark">âœ“</text>
          </view>
        </view>
        
        <!-- é—®é¢˜å†…å®¹ -->
        <view class="issue-content" bindtap="{{isEditMode ? '' : 'viewDetail'}}" data-id="{{item._id}}">
          <!-- é—®é¢˜å¤´éƒ¨ -->
          <view class="issue-header">
            <text class="issue-title">{{item.title}}</text>
            <view class="status-badge">
              å·²è§£å†³
            </view>
          </view>

        <!-- é—®é¢˜ç¼–å· -->
        <view class="issue-id" wx:if="{{item.issueId}}">
          <text class="id-label">é—®é¢˜ç¼–å·:</text>
          <text class="id-value">{{item.issueId}}</text>
        </view>

        <!-- é—®é¢˜æè¿° -->
        <text class="issue-description">{{item.description}}</text>

        <!-- è§£å†³æ–¹æ¡ˆ -->
        <view class="solution-section" wx:if="{{item.solution}}">
          <text class="solution-label">è§£å†³æ–¹æ¡ˆ:</text>
          <text class="solution-text">{{item.solution}}</text>
        </view>

        <!-- é—®é¢˜ä¿¡æ¯ -->
        <view class="issue-info">
          <view class="info-item">
            <text class="info-label">åˆ†ç±»:</text>
            <text class="info-value">{{item.category}}</text>
          </view>
          <view class="info-item">
            <text class="info-label">è®¾å¤‡:</text>
            <text class="info-value">{{item.deviceName || 'æœªçŸ¥è®¾å¤‡'}}</text>
          </view>
        </view>

        <!-- ç»´ä¿®å·¥ä¿¡æ¯ -->
        <view class="worker-info">
          <text class="worker-label">ç»´ä¿®å·¥:</text>
          <text class="worker-name">{{item.resolvedWorkerName || item.assignedWorkerName}}</text>
        </view>

        <!-- æ—¶é—´ä¿¡æ¯ -->
        <view class="time-info">
          <view class="time-item">
            <text class="time-label">æŠ¥å‘Šæ—¶é—´:</text>
            <text class="time-value">{{item.createTime}}</text>
          </view>
          <view class="time-item">
            <text class="time-label">è§£å†³æ—¶é—´:</text>
            <text class="time-value">{{item.resolvedTime}}</text>
          </view>
        </view>

          <!-- æ“ä½œæŒ‰é’® -->
          <view class="actions" wx:if="{{!isEditMode}}">
            <button class="btn-detail" size="mini" catchtap="viewDetail" data-id="{{item._id}}">
              æŸ¥çœ‹è¯¦æƒ…
            </button>
            <button wx:if="{{item.images && item.images.length > 0}}" class="btn-images" size="mini" catchtap="viewImages" data-images="{{item.images}}">
              æŸ¥çœ‹ç…§ç‰‡
            </button>
          </view>
          
          <!-- å•ç‹¬åˆ é™¤æŒ‰é’®ï¼ˆç¼–è¾‘æ¨¡å¼ä¸‹ï¼‰ -->
          <view class="actions" wx:if="{{isEditMode}}">
            <button class="btn-delete-single" size="mini" catchtap="deleteSingle" data-id="{{item._id}}">
              åˆ é™¤
            </button>
          </view>
        </view>
      </view>
    </view>

    <!-- ç©ºçŠ¶æ€ -->
    <view wx:if="{{!isLoading && issues.length === 0}}" class="empty-state">
      <view class="empty-icon">ğŸ“‹</view>
      <text class="empty-text">æš‚æ— å·²è§£å†³é—®é¢˜</text>
    </view>

    <!-- åŠ è½½çŠ¶æ€ -->
    <view wx:if="{{isLoading}}" class="loading-state">
      <text>åŠ è½½ä¸­...</text>
    </view>

    <!-- åŠ è½½æ›´å¤š -->
    <view wx:if="{{!isLoading && hasMore && issues.length > 0}}" class="load-more">
      <text>ä¸Šæ‹‰åŠ è½½æ›´å¤š</text>
    </view>

    <!-- æ²¡æœ‰æ›´å¤š -->
    <view wx:if="{{!hasMore && issues.length > 0}}" class="no-more">
      <text>æ²¡æœ‰æ›´å¤šäº†</text>
    </view>
  </scroll-view>
</view>