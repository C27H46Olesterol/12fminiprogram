<!--pages/manager/issue-detail/issue-detail.wxml-->
<wxs module="utils">
  // è·å–çŠ¶æ€æ–‡æœ¬
  var getStatusText = function(status) {
    var map = {
      'pending': 'å¾…å¤„ç†',
      'assigned': 'å·²åˆ†é…',
      'processing': 'å¤„ç†ä¸­',
      'parts_request': 'é…ä»¶ç”³è¯·ä¸­',
      'parts_sent': 'é…ä»¶å·²å‘å‡º',
      'parts_received': 'è¿”ä»¶å·²æ”¶åˆ°',
      'resolved': 'å·²è§£å†³',
      'closed': 'å·²å…³é—­',
      'cancelled': 'å·²å–æ¶ˆ'
    };
    return map[status] || 'æœªçŸ¥';
  };

  // è·å–ä¼˜å…ˆçº§æ–‡æœ¬
  var getPriorityText = function(priority) {
    var map = {
      'low': 'ä½',
      'medium': 'ä¸­',
      'high': 'é«˜',
      'urgent': 'ç´§æ€¥'
    };
    return map[priority] || 'æœªè®¾ç½®';
  };

  // è·å–ä¼˜å…ˆçº§é¢œè‰²
  var getPriorityColor = function(priority) {
    var map = {
      'low': '#52c41a',
      'medium': '#1890ff',
      'high': '#fa8c16',
      'urgent': '#f5222d'
    };
    return map[priority] || '#666';
  };

  // æ ¼å¼åŒ–æ—¶é—´
  var formatTime = function(timestamp) {
    if (!timestamp) return '';
    
    var date = getDate(timestamp);
    var year = date.getFullYear();
    var month = (date.getMonth() + 1).toString();
    var day = date.getDate().toString();
    var hours = date.getHours().toString();
    var minutes = date.getMinutes().toString();
    
    if (month.length < 2) month = '0' + month;
    if (day.length < 2) day = '0' + day;
    if (hours.length < 2) hours = '0' + hours;
    if (minutes.length < 2) minutes = '0' + minutes;
    
    return year + '-' + month + '-' + day + ' ' + hours + ':' + minutes;
  };

  module.exports = {
    getStatusText: getStatusText,
    getPriorityText: getPriorityText,
    getPriorityColor: getPriorityColor,
    formatTime: formatTime
  };
</wxs>

<view class="container issue-detail-page">
  <!-- é¡µé¢æ ‡é¢˜ -->
  <view class="page-header mb-20">
    <text class="page-title">é—®é¢˜è¯¦æƒ…</text>
    <view class="status-tag status-{{issue.status}}">{{utils.getStatusText(issue.status)}}</view>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{isLoading}}" class="loading-state flex flex-center">
    <text class="text-secondary">åŠ è½½ä¸­...</text>
  </view>

  <!-- é—®é¢˜è¯¦æƒ… -->
  <view wx:else class="content-wrapper">
    <!-- åŸºæœ¬ä¿¡æ¯å¡ç‰‡ -->
    <view class="card info-card">
      <view class="card-header flex flex-between flex-v-center">
        <text class="card-title">åŸºæœ¬ä¿¡æ¯</text>
        <text class="priority-tag" style="color: {{utils.getPriorityColor(issue.priority)}}; border-color: {{utils.getPriorityColor(issue.priority)}}">
          {{utils.getPriorityText(issue.priority)}}ä¼˜å…ˆçº§
        </text>
      </view>
      
      <view class="info-row">
        <text class="label">é—®é¢˜ç¼–å·</text>
        <text class="value">#{{issue.issueId}}</text>
      </view>
      <view class="info-row">
        <text class="label">é—®é¢˜æ ‡é¢˜</text>
        <text class="value font-bold">{{issue.title}}</text>
      </view>
      <view class="info-row">
        <text class="label">é—®é¢˜æè¿°</text>
        <text class="value">{{issue.description}}</text>
      </view>
      <view class="info-row">
        <text class="label">åˆ›å»ºæ—¶é—´</text>
        <text class="value">{{utils.formatTime(issue.createTime)}}</text>
      </view>
    </view>

    <!-- è”ç³»äººä¿¡æ¯å¡ç‰‡ -->
    <view class="card contact-card">
      <view class="card-header">
        <text class="card-title">è”ç³»äººä¿¡æ¯</text>
      </view>
      <view class="info-row">
        <text class="label">å§“å</text>
        <text class="value">{{issue.clientName}}</text>
      </view>
      <view class="info-row">
        <text class="label">ç”µè¯</text>
        <text class="value phone-link" bindtap="onCallPhone" data-phone="{{issue.reporterPhone}}">{{issue.reporterPhone}} ğŸ“</text>
      </view>
      <view class="info-row">
        <text class="label">åœ°å€</text>
        <text class="value">{{issue.clientAddress}}</text>
      </view>
      <view class="info-row">
        <text class="label">äº§å“å‹å·</text>
        <text class="value">{{issue.productModel}}</text>
      </view>
    </view>

    <!-- ç»´ä¿®ä¿¡æ¯å¡ç‰‡ -->
    <view class="card repair-card" wx:if="{{issue.assignedWorkerName}}">
      <view class="card-header">
        <text class="card-title">ç»´ä¿®ä¿¡æ¯</text>
      </view>
      <view class="info-row">
        <text class="label">ç»´ä¿®å·¥</text>
        <text class="value">{{issue.assignedWorkerName}}</text>
      </view>
      <view class="info-row" wx:if="{{issue.assignedTime}}">
        <text class="label">åˆ†é…æ—¶é—´</text>
        <text class="value">{{utils.formatTime(issue.assignedTime)}}</text>
      </view>
      <view class="info-row" wx:if="{{issue.processingTime}}">
        <text class="label">å¼€å§‹å¤„ç†</text>
        <text class="value">{{utils.formatTime(issue.processingTime)}}</text>
      </view>
      <view class="info-row" wx:if="{{issue.resolvedTime}}">
        <text class="label">å®Œæˆæ—¶é—´</text>
        <text class="value">{{utils.formatTime(issue.resolvedTime)}}</text>
      </view>
      <view class="info-row" wx:if="{{issue.resultDescription}}">
        <text class="label">å¤„ç†ç»“æœ</text>
        <text class="value">{{issue.resultDescription}}</text>
      </view>
    </view>

    <!-- ä»»åŠ¡è¿›åº¦è¯¦æƒ…å¡ç‰‡ -->
    <view class="card progress-detail-card" wx:if="{{issue.status !== 'pending' && issue.status !== 'assigned'}}">
      <view class="card-header">
        <text class="card-title">ä»»åŠ¡è¿›åº¦è¯¦æƒ…</text>
      </view>
      
      <view class="info-row">
        <text class="label">é…ä»¶éœ€æ±‚</text>
        <text class="value">{{issue.needParts ? 'éœ€è¦é…ä»¶' : 'æ— éœ€é…ä»¶'}}</text>
      </view>
      
      <view wx:if="{{issue.needParts && issue.partsDetail}}" class="info-row">
        <text class="label">é…ä»¶è¯¦æƒ…</text>
        <text class="value">{{issue.partsDetail}}</text>
      </view>

      <!-- æ›´å¤šé…ä»¶ç›¸å…³ä¿¡æ¯æŒ‰éœ€å±•ç¤º -->
      <view wx:if="{{issue.partsSentTime}}" class="info-row">
        <text class="label">é…ä»¶å‘å‡º</text>
        <text class="value">{{utils.formatTime(issue.partsSentTime)}}</text>
      </view>
      
      <view wx:if="{{issue.trackingNumber}}" class="info-row">
        <text class="label">å¿«é€’å•å·</text>
        <text class="value">{{issue.trackingNumber}}</text>
      </view>
    </view>

    <!-- é—®é¢˜å›¾ç‰‡å¡ç‰‡ -->
    <view class="card image-card">
      <view class="card-header">
        <text class="card-title">é—®é¢˜å›¾ç‰‡</text>
      </view>
      <view wx:if="{{issue.imageUrls && issue.imageUrls.length > 0}}" class="image-grid">
        <image 
          wx:for="{{issue.imageUrls}}" 
          wx:key="index"
          src="{{item}}" 
          class="detail-image"
          mode="aspectFill"
          bindtap="onPreviewImage"
          data-src="{{item}}"
          data-index="{{index}}"
        />
      </view>
      <view wx:else class="empty-images">
        <text class="text-secondary">æš‚æ— å›¾ç‰‡</text>
      </view>
    </view>

    <!-- çŠ¶æ€å†å²å¡ç‰‡ -->
    <view class="card history-card" wx:if="{{history && history.length > 0}}">
      <view class="card-header">
        <text class="card-title">çŠ¶æ€å†å²</text>
      </view>
      <view class="history-timeline">
        <view 
          wx:for="{{history}}" 
          wx:key="index"
          class="timeline-item"
        >
          <view class="timeline-dot"></view>
          <view class="timeline-content">
            <view class="flex flex-between mb-10">
              <text class="history-status">{{utils.getStatusText(item.status)}}</text>
              <text class="history-time text-secondary">{{utils.formatTime(item.createTime || item.timestamp)}}</text>
            </view>
            <text class="history-operator text-secondary">æ“ä½œäºº: {{item.operatorName}}</text>
            <view class="history-remark" wx:if="{{item.remark}}">{{item.remark}}</view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- åº•éƒ¨æ“ä½œæ  -->
  <view class="bottom-action-bar">
    <!-- å¾…å¤„ç†ï¼šåˆ†é… -->
    <button 
      wx:if="{{issue.status === 'pending'}}"
      class="btn btn-primary btn-block" 
      bindtap="onShowAssignModal"
    >
      åˆ†é…ç»´ä¿®å·¥
    </button>
    
    <!-- å·²åˆ†é…ï¼šå¼€å§‹å¤„ç† -->
    <button 
      wx:if="{{issue.status === 'assigned'}}"
      class="btn btn-primary btn-block" 
      bindtap="onStartProcessing"
    >
      å¼€å§‹å¤„ç†
    </button>

    <!-- å¤„ç†ä¸­ï¼šå®Œæˆæˆ–é…ä»¶ -->
    <view wx:if="{{issue.status === 'processing'}}" class="flex gap-20">
      <button 
        wx:if="{{!issue.needParts}}"
        class="btn btn-primary btn-block" 
        bindtap="onCompleteTask"
      >
        å®Œæˆä»»åŠ¡
      </button>
      <button 
        wx:if="{{issue.needParts && issue.status !== 'parts_sent' && issue.status !== 'parts_received'}}"
        class="btn btn-warning btn-block" 
        bindtap="onSendParts"
      >
        å‘å‡ºé…ä»¶
      </button>
    </view>

    <!-- é€šç”¨ï¼šè®¾ç½®ä¼˜å…ˆçº§ -->
    <button 
      wx:if="{{issue.status !== 'resolved' && issue.status !== 'closed'}}"
      class="btn btn-outline btn-block mt-20" 
      bindtap="onShowPriorityModal"
    >
      è®¾ç½®ä¼˜å…ˆçº§
    </button>
  </view>

  <!-- å¼¹çª—ç»„ä»¶ä¿æŒåŸæœ‰é€»è¾‘ï¼Œä»…æ›´æ–°æ ·å¼ç±» -->
  <!-- åˆ†é…ç»´ä¿®å·¥å¼¹çª— -->
  <view class="modal-mask" wx:if="{{showAssignModal}}" bindtap="onHideAssignModal"></view>
  <view class="modal-container" wx:if="{{showAssignModal}}">
    <view class="modal-header">
      <text class="modal-title">åˆ†é…ç»´ä¿®å·¥</text>
      <text class="close-icon" bindtap="onHideAssignModal">Ã—</text>
    </view>
    <view class="modal-content">
      <view class="search-box mb-20">
        <input class="form-input" placeholder="æœç´¢ç»´ä¿®å·¥" value="{{workerSearchKeyword}}" bindinput="onWorkerSearch" />
      </view>
      <scroll-view scroll-y class="worker-list-scroll">
        <view 
          wx:for="{{filteredWorkers}}" 
          wx:key="_id"
          class="worker-item {{selectedWorkerId === item._id ? 'selected' : ''}}"
          bindtap="onSelectWorker"
          data-id="{{item._id}}"
        >
          <view class="flex flex-between">
            <text class="font-bold">{{item.nickname}}</text>
            <text class="text-secondary">{{item.phone}}</text>
          </view>
        </view>
      </scroll-view>
    </view>
    <view class="modal-footer flex gap-20">
      <button class="btn btn-outline flex-1" bindtap="onHideAssignModal">å–æ¶ˆ</button>
      <button class="btn btn-primary flex-1" bindtap="onConfirmAssign">ç¡®è®¤</button>
    </view>
  </view>

  <!-- è®¾ç½®ä¼˜å…ˆçº§å¼¹çª— -->
  <view class="modal-mask" wx:if="{{showPriorityModal}}" bindtap="onHidePriorityModal"></view>
  <view class="modal-container" wx:if="{{showPriorityModal}}">
    <view class="modal-header">
      <text class="modal-title">è®¾ç½®ä¼˜å…ˆçº§</text>
      <text class="close-icon" bindtap="onHidePriorityModal">Ã—</text>
    </view>
    <view class="modal-content">
      <picker range="{{priorityOptions}}" value="{{getPriorityIndex(selectedPriority)}}" bindchange="onPriorityChange">
        <view class="picker-item form-input flex flex-between">
          <text>é€‰æ‹©ä¼˜å…ˆçº§</text>
          <text class="text-primary">{{utils.getPriorityText(selectedPriority)}}</text>
        </view>
      </picker>
    </view>
    <view class="modal-footer flex gap-20">
      <button class="btn btn-outline flex-1" bindtap="onHidePriorityModal">å–æ¶ˆ</button>
      <button class="btn btn-primary flex-1" bindtap="onConfirmPriority">ç¡®è®¤</button>
    </view>
  </view>

</view>