<!--pages/admin/user-management/user-management.wxml-->
<wxs module="utils">
  var getRoleText = function(role) {
    var roleMap = {
      'client': 'å®¢æˆ·',
      'manager': 'ä¸»ç®¡',
      'worker': 'ç»´ä¿®å·¥',
      'admin': 'ç³»ç»Ÿç®¡ç†å‘˜'
    };
    return roleMap[role] || 'æœªçŸ¥';
  };
  
  var getRoleColor = function(role) {
    var colorMap = {
      'client': '#1677ff',
      'manager': '#ff7d00',
      'worker': '#52C41A',
      'admin': '#722ED1'
    };
    return colorMap[role] || '#666666';
  };
  
  module.exports = {
    getRoleText: getRoleText,
    getRoleColor: getRoleColor
  };
</wxs>

<view class="container">
  <!-- é¡µé¢å¤´éƒ¨ -->
  <view class="page-header">
    <view class="header-left">
      <button class="back-btn" bindtap="goBack">
        <text class="back-icon">â†</text>
        <text class="back-text">è¿”å›</text>
      </button>
    </view>
    <view class="header-center">
      <view class="header-title">ç”¨æˆ·ç®¡ç†</view>
      <view class="header-desc">ç®¡ç†ç”¨æˆ·è§’è‰²æƒé™</view>
    </view>
    <view class="header-right">
      <button class="nav-btn" bindtap="goToProfile">
        <text class="nav-icon">ğŸ‘¤</text>
      </button>
    </view>
  </view>
  
  <!-- æœç´¢å’Œç­›é€‰ -->
  <view class="search-section">
    <view class="search-bar">
      <input 
        class="search-input"
        placeholder="æœç´¢ç”¨æˆ·æ˜µç§°æˆ–æ‰‹æœºå·"
        value="{{searchKeyword}}"
        bindinput="onSearchInput"
      />
      <text class="search-icon">ğŸ”</text>
    </view>
    
    <view class="filter-bar">
      <picker 
        range="{{roles}}" 
        range-key="label"
        value="{{selectedRole === 'all' ? 0 : selectedRole === 'client' ? 1 : selectedRole === 'manager' ? 2 : selectedRole === 'worker' ? 3 : 4}}"
        bindchange="onRoleChange"
      >
        <view class="filter-display">
          <text class="filter-text">{{selectedRoleText}}</text>
          <text class="filter-arrow">></text>
        </view>
      </picker>
    </view>

    <!-- åœ°åŸŸç­›é€‰ - ç‚¹å‡»æ˜¾ç¤ºå¼¹çª— -->
    <view class="location-filter">
      <view class="filter-display" bindtap="showRegionModal">
        <text class="filter-icon">ğŸ“</text>
        <text class="filter-text">{{selectedRegionText}}</text>
        <text class="filter-arrow">></text>
      </view>
    </view>
  </view>
  
  <!-- ç”¨æˆ·åˆ—è¡¨ -->
  <view class="user-list">
    <view wx:if="{{loading}}" class="loading-placeholder">
      <view class="loading-spinner">
        <view class="spinner-dot"></view>
        <view class="spinner-dot"></view>
        <view class="spinner-dot"></view>
      </view>
      <text class="loading-text">åŠ è½½ä¸­...</text>
    </view>
    
    <view wx:elif="{{filteredUsers.length === 0}}" class="empty-placeholder">
      <text class="empty-icon">ğŸ‘¥</text>
      <text class="empty-text">æš‚æ— ç”¨æˆ·æ•°æ®</text>
    </view>
    
    <view wx:else class="list">
      <view class="list-item" wx:for="{{filteredUsers}}" wx:key="id" data-debug-id="{{item.id}}">
        <view class="user-info">
          <view class="user-name">å§“åï¼š{{item.nickname || 'æœªè®¾ç½®æ˜µç§°'}}</view>
          <view class="user-meta">
            <text class="user-phone" wx:if="{{item.phone}}">æ‰‹æœºå·ï¼š{{item.phone}}</text>
          </view>
          <view class="user-meta" wx:if="{{item.role === 'worker' && item.region}}">
            <text class="user-region">æ³¨å†Œåœ°åŒºï¼š{{item.region}}</text>
          </view>
          <view class="user-meta">
            <view class="user-role-badge" style="background-color: {{utils.getRoleColor(item.role)}}">
              èº«ä»½ï¼š{{utils.getRoleText(item.role)}}
            </view>
          </view>
        </view>
        
        <view class="user-actions">
        <button 
          class="change-role-btn"
          data-userid="{{item.id}}"
          data-currentrole="{{item.role}}"
          bindtap="changeUserRole"
          disabled="{{submitting}}"
        >
          ä¿®æ”¹è§’è‰²
        </button>
        </view>
      </view>
    </view>
  </view>
  
  <!-- ç»Ÿè®¡ä¿¡æ¯ -->
  <view class="stats-section">
    <view class="stats-item">
      <view class="stats-number">{{stats.total}}</view>
      <view class="stats-label">æ€»ç”¨æˆ·æ•°</view>
    </view>
    <view class="stats-item">
      <view class="stats-number">{{stats.client}}</view>
      <view class="stats-label">å®¢æˆ·</view>
    </view>
    <view class="stats-item">
      <view class="stats-number">{{stats.manager}}</view>
      <view class="stats-label">ä¸»ç®¡</view>
    </view>
    <view class="stats-item">
      <view class="stats-number">{{stats.worker}}</view>
      <view class="stats-label">ç»´ä¿®å·¥</view>
    </view>
    <view class="stats-item">
      <view class="stats-number">{{stats.admin}}</view>
      <view class="stats-label">ç®¡ç†å‘˜</view>
    </view>
  </view>
  
  <!-- åº•éƒ¨å¯¼èˆªæ  -->
  <view class="bottom-nav">
    <view class="nav-item" bindtap="goToHome">
      <text class="nav-icon">ğŸ </text>
      <text class="nav-text">é¦–é¡µ</text>
    </view>
    <view class="nav-item" bindtap="goToProfile">
      <text class="nav-icon">ğŸ‘¤</text>
      <text class="nav-text">ä¸ªäººä¸­å¿ƒ</text>
    </view>
    <view class="nav-item active">
      <text class="nav-icon">ğŸ‘¥</text>
      <text class="nav-text">ç”¨æˆ·ç®¡ç†</text>
    </view>
    <view class="nav-item" bindtap="goToSettings">
      <text class="nav-icon">âš™ï¸</text>
      <text class="nav-text">è®¾ç½®</text>
    </view>
  </view>

  <!-- åœ°åŒºé€‰æ‹©å¼¹çª— -->
  <view class="region-modal" wx:if="{{showRegionModal}}" catchtap="hideRegionModal">
    <view class="region-modal-content" catchtap="stopPropagation">
      <!-- æœç´¢æ¡† -->
      <view class="region-search-box">
        <input 
          class="region-search-input"
          placeholder="æœç´¢çœä»½æˆ–åŸå¸‚"
          value="{{regionSearchKeyword}}"
          bindinput="onRegionSearchInput"
        />
        <text class="region-search-icon">ğŸ”</text>
      </view>

      <!-- åœ°åŒºåˆ—è¡¨ -->
      <scroll-view class="region-list" scroll-y>
        <view 
          class="region-item {{selectedRegion === '' ? 'active' : ''}}"
          bindtap="selectRegion"
          data-region=""
        >
          å…¨éƒ¨
        </view>
        <view 
          class="region-item {{selectedRegion === item ? 'active' : ''}}"
          wx:for="{{filteredWorkerRegions}}"
          wx:key="*this"
          bindtap="selectRegion"
          data-region="{{item}}"
        >
          {{item}}
        </view>
      </scroll-view>

      <!-- åº•éƒ¨æŒ‰é’® -->
      <view class="region-modal-footer">
        <button class="region-btn cancel" bindtap="hideRegionModal">å–æ¶ˆ</button>
        <button class="region-btn confirm" bindtap="confirmRegion">ç¡®å®š</button>
      </view>
    </view>
  </view>
</view>
