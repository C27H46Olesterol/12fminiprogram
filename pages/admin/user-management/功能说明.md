# 用户管理页面 - 功能说明

## 🎯 新增功能

### 1. ✅ 高级地域筛选（三列滑动选择器）

**功能描述：**
- 支持省-市-区三级联动选择
- 覆盖全国主要城市和区县
- 滑动选择，操作流畅

**支持的地域：**
- **北京市**：东城区、西城区、朝阳区、海淀区、丰台区、石景山区、通州区、昌平区
- **上海市**：黄浦区、徐汇区、长宁区、静安区、普陀区、虹口区、杨浦区、浦东新区
- **广东省**：
  - 广州市：天河区、越秀区、海珠区、荔湾区、白云区、黄埔区、番禺区、花都区
  - 深圳市：福田区、罗湖区、南山区、宝安区、龙岗区、龙华区、坪山区、盐田区
  - 东莞市：莞城区、南城区、东城区、万江区、长安镇、虎门镇、厚街镇、塘厦镇
- **浙江省**：
  - 杭州市：西湖区、上城区、下城区、江干区、拱墅区、滨江区、萧山区、余杭区
  - 宁波市：海曙区、江北区、鄞州区、镇海区、北仑区、奉化区、余姚市、慈溪市
- **四川省**：成都市（锦江区、青羊区、金牛区、武侯区、成华区、龙泉驿区、温江区、双流区）
- **湖北省**：武汉市（江岸区、江汉区、硚口区、汉阳区、武昌区、青山区、洪山区、东西湖区）
- **陕西省**：西安市（新城区、碑林区、莲湖区、雁塔区、未央区、灞桥区、长安区、高新区）
- **江苏省**：
  - 南京市：玄武区、秦淮区、建邺区、鼓楼区、浦口区、栖霞区、雨花台区、江宁区
  - 苏州市：姑苏区、虎丘区、吴中区、相城区、吴江区、昆山市、常熟市、张家港市
- **山东省**：
  - 济南市：历下区、市中区、槐荫区、天桥区、历城区、长清区、章丘区、济阳区
  - 青岛市：市南区、市北区、李沧区、崂山区、黄岛区、城阳区、即墨区、胶州市

**使用方法：**
1. 点击"全部地域"筛选框
2. 三列滑动选择：省份 → 城市 → 区县
3. 选择完成后自动筛选用户

---

### 2. ✅ 获取我的位置

**功能描述：**
- 使用微信定位API获取当前位置
- 显示经纬度信息
- 为"找附近维修工"功能提供基础

**使用方法：**
1. 点击"获取我的位置"按钮
2. 授权位置权限
3. 系统自动获取并显示当前位置

**技术实现：**
- 使用 `wx.getLocation` API
- 坐标系统：GCJ-02（火星坐标系）
- 支持逆地理编码（可扩展）

---

### 3. ✅ 查看地图

**功能描述：**
- 在地图上查看用户位置
- 支持选择位置
- 可视化展示用户分布

**使用方法：**
1. 先获取我的位置
2. 点击"查看地图"按钮
3. 在地图上查看和选择位置

**技术实现：**
- 使用 `wx.chooseLocation` API
- 支持标记点展示
- 可扩展为完整地图页面

---

### 4. ✅ 找附近的维修工

**功能描述：**
- 自动筛选所有维修工
- 计算距离并按从近到远排序
- 显示每个维修工的距离

**使用方法：**
1. 先获取我的位置
2. 点击"找附近维修工"按钮
3. 系统自动筛选并排序显示

**距离计算：**
- 使用 Haversine 公式
- 精确计算球面距离
- 单位自动转换（米/公里）

**Bug修复：**
- ✅ 修复了筛选后显示非维修工用户的问题
- ✅ 严格筛选 `role === 'worker'`
- ✅ 重置地域筛选，避免干扰
- ✅ 添加调试日志，便于排查问题

---

## 🎨 界面优化

### 按钮设计
- **获取位置**：绿色渐变（#52C41A → #73D13D）
- **查看地图**：蓝色渐变（#1677ff → #42A5F5）
- **找附近维修工**：橙色渐变（#FF7D00 → #FFA940）

### 信息展示
- 用户列表显示地域信息（蓝色 📍）
- 用户列表显示距离信息（橙色 🚗）
- 当前位置信息条（蓝色边框高亮）

---

## 📊 数据结构

### 用户对象新增字段
```javascript
{
  latitude: Number,      // 纬度
  longitude: Number,     // 经度
  region: String,        // 地域（如：北京市海淀区）
  distance: String,      // 距离文本（如：1.2公里）
  distanceValue: Number  // 距离数值（用于排序）
}
```

---

## 🔧 技术实现

### 距离计算算法（Haversine公式）
```javascript
calculateDistance(lat1, lon1, lat2, lon2) {
  const R = 6371; // 地球半径（公里）
  const dLat = this.deg2rad(lat2 - lat1);
  const dLon = this.deg2rad(lon2 - lon1);
  const a = 
    Math.sin(dLat / 2) * Math.sin(dLat / 2) +
    Math.cos(this.deg2rad(lat1)) * Math.cos(this.deg2rad(lat2)) *
    Math.sin(dLon / 2) * Math.sin(dLon / 2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return R * c;
}
```

### 三列选择器联动
- 省份变化 → 更新城市列表 → 重置区县列表
- 城市变化 → 更新区县列表
- 支持"全部"选项，灵活筛选

---

## 📝 权限配置

已在 `app.json` 中添加位置权限：
```json
{
  "permission": {
    "scope.userLocation": {
      "desc": "您的位置信息将用于查找附近的维修工和地图服务"
    }
  },
  "requiredPrivateInfos": [
    "getLocation",
    "chooseLocation"
  ]
}
```

---

## 🐛 已修复的问题

1. ✅ **找附近维修工显示错误角色**
   - 问题：筛选后显示客户等非维修工用户
   - 原因：地域筛选和角色筛选冲突
   - 解决：重置地域筛选，严格筛选维修工

2. ✅ **地域筛选不够精确**
   - 问题：只能选择单一城市
   - 解决：实现省-市-区三级联动选择

---

## 🚀 使用建议

1. **首次使用**：先点击"获取我的位置"授权位置权限
2. **查找维修工**：确保已获取位置后再点击"找附近维修工"
3. **地域筛选**：可以只选择省份或省+市，不必全部选择
4. **组合筛选**：地域筛选和角色筛选可以组合使用

---

## 📱 测试说明

为了便于测试，系统会为没有位置信息的用户自动生成模拟数据：
- 随机生成北京附近的经纬度
- 随机分配地域信息
- 生产环境建议移除此功能

---

## 🔮 未来扩展

1. **地图页面**：创建独立的地图展示页面
2. **实时定位**：支持实时更新用户位置
3. **路径规划**：集成导航功能
4. **位置分享**：支持分享位置给其他用户
5. **地理围栏**：设置服务范围限制

---

**版本**：v2.0  
**更新时间**：2025-10-26  
**开发者**：AI Assistant

