# è¯„ä»·åŠŸèƒ½"åŠ è½½å¤±è´¥"é—®é¢˜ä¿®å¤è¯´æ˜

## é—®é¢˜æè¿°
ä¸»ç®¡åœ¨"è¯„åˆ†åé¦ˆ"é¡µé¢ç‚¹å‡»"ç«‹å³è¯„ä»·"åï¼Œæ˜¾ç¤º"åŠ è½½å¤±è´¥"é”™è¯¯ï¼Œä½†å®é™…ä¸Šä»ç„¶å¯ä»¥ç»§ç»­è¯„ä»·å¹¶æäº¤æˆåŠŸã€‚

## é—®é¢˜åŸå› 
1. å·¥å•IDæœ‰å¤šç§æ ¼å¼ï¼š
   - `M-251101-006`ï¼ˆä»¥ `M-` å¼€å¤´ï¼‰
   - `ISSUE_xxx`ï¼ˆä»¥ `ISSUE_` å¼€å¤´ï¼‰
   - MongoDB çš„ `_id`ï¼ˆä»¥ `issue_` å¼€å¤´ï¼‰
2. åŸæ¥çš„æŸ¥è¯¢é€»è¾‘åªæ£€æŸ¥ `ISSUE_` å¼€å¤´çš„IDï¼Œå¯¼è‡´ `M-` å¼€å¤´çš„å·¥å•IDæ— æ³•è¢«è¯†åˆ«
3. è¿™å¯¼è‡´æŸ¥è¯¢å¤±è´¥ï¼Œæ˜¾ç¤º"é—®é¢˜ä¸å­˜åœ¨"çš„é”™è¯¯

## ä¿®å¤æ–¹æ¡ˆ

### 1. å‰ç«¯ä¿®æ”¹

#### 1.1 `pages/manager/rating-feedback/rating-feedback.js`
**ä¿®æ”¹ç‚¹ 1: æ·»åŠ è°ƒè¯•æ—¥å¿—å’Œå¤‡é€‰ID**
- åœ¨ `onRateIssue` å‡½æ•°ä¸­æ·»åŠ è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—
- å¦‚æœ `issueId` ä¸ºç©ºï¼Œè‡ªåŠ¨ä½¿ç”¨ `_id` ä½œä¸ºå¤‡é€‰
- ä½ç½®: ç¬¬134-163è¡Œ

**ä¿®æ”¹ç‚¹ 2: æ·»åŠ æ•°æ®éªŒè¯æ—¥å¿—**
- åœ¨ `loadIssues` å‡½æ•°ä¸­æ·»åŠ å·¥å•æ•°æ®çš„æ—¥å¿—è¾“å‡º
- ç”¨äºéªŒè¯æ¯ä¸ªå·¥å•æ˜¯å¦æœ‰æ­£ç¡®çš„ `issueId` å­—æ®µ
- ä½ç½®: ç¬¬78-82è¡Œ

#### 1.2 `pages/manager/rate-issue/rate-issue.js`
**ä¿®æ”¹ç‚¹: æ·»åŠ è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—**
- åœ¨ `onLoad` å‡½æ•°ä¸­è®°å½•æ¥æ”¶åˆ°çš„å‚æ•°
- åœ¨ `loadIssueDetail` å‡½æ•°ä¸­è®°å½•æŸ¥è¯¢è¿‡ç¨‹
- ä½ç½®: ç¬¬15-30è¡Œ, ç¬¬51-77è¡Œ

#### 1.3 `pages/client/rate-issue/rate-issue.js`
**ä¿®æ”¹ç‚¹: æ·»åŠ è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—**ï¼ˆå¦‚æœå®¢æˆ·ç«¯ä¹Ÿä½¿ç”¨æ­¤é¡µé¢ï¼‰
- ä¸ä¸»ç®¡ç‰ˆæœ¬ç›¸åŒçš„æ—¥å¿—æ”¹è¿›
- ä½ç½®: ç¬¬14-31è¡Œ, ç¬¬45-71è¡Œ

### 2. äº‘å‡½æ•°ä¿®æ”¹

#### 2.1 `cloud/functions/issues/index.js` - `getIssueDetail` å’Œ `submitManagerRating` å‡½æ•°
**ä¿®æ”¹ç‚¹: å¢åŠ å¤šç§æŸ¥è¯¢æ–¹å¼**
- åŸæ¥åªæ£€æŸ¥ `ISSUE_` å¼€å¤´çš„ID
- ç°åœ¨å¢åŠ äº†å¯¹ `M-` å¼€å¤´IDçš„è¯†åˆ«ï¼š
  1. ä¼˜å…ˆé€šè¿‡ `issueId` å­—æ®µæŸ¥è¯¢ï¼ˆå¦‚æœIDä»¥ `M-` æˆ– `ISSUE_` å¼€å¤´ï¼‰
  2. å¦‚æœå¤±è´¥ï¼Œå°è¯•é€šè¿‡ `_id` å­—æ®µç›´æ¥æŸ¥è¯¢æ–‡æ¡£
- ä½¿ç”¨å·¥å•çš„å®é™… `issueId` æˆ– `_id` è¿›è¡Œæ›´æ–°å’Œè®°å½•å†å²
- ä½ç½®: 
  - `getIssueDetail`: ç¬¬878-897è¡Œ
  - `submitManagerRating`: ç¬¬2757-2785è¡Œ

```javascript
// åˆ¤æ–­ ID ç±»å‹å¹¶é€‰æ‹©æŸ¥è¯¢æ–¹å¼
const isFormattedId = issueId.startsWith('M-') || issueId.startsWith('ISSUE_');

// ä¼˜å…ˆé€šè¿‡ issueId å­—æ®µæŸ¥è¯¢ï¼ˆå¦‚æœæ˜¯æ ¼å¼åŒ–çš„ IDï¼‰
if (isFormattedId) {
  console.log('âœ… é€šè¿‡ issueId å­—æ®µæŸ¥è¯¢:', issueId);
  issueResult = await db.collection('issues').where({
    issueId: issueId
  }).get();
  console.log('ğŸ“‹ æŸ¥è¯¢ç»“æœæ•°é‡:', issueResult.data.length);
}

// å¦‚æœ issueId æŸ¥è¯¢å¤±è´¥ï¼Œå°è¯•é€šè¿‡ _id æŸ¥è¯¢
if (issueResult.data.length === 0) {
  console.log('ğŸ” å°è¯•é€šè¿‡ _id å­—æ®µæŸ¥è¯¢:', issueId);
  try {
    const docResult = await db.collection('issues').doc(issueId).get();
    if (docResult.data) {
      issueResult.data = [docResult.data];
      console.log('âœ… é€šè¿‡ _id æŸ¥è¯¢æˆåŠŸ');
    }
  } catch (docError) {
    console.log('âŒ é€šè¿‡ _id æŸ¥è¯¢å¤±è´¥:', docError.message);
  }
}
```

## ä¿®å¤æ•ˆæœ

1. **å…¼å®¹æ€§æå‡**: ç°åœ¨å¯ä»¥åŒæ—¶æ”¯æŒå¤šç§æ ¼å¼çš„å·¥å•ID
   - `M-` å¼€å¤´çš„å·¥å•: `M-251101-006`
   - `ISSUE_` å¼€å¤´çš„å·¥å•: `ISSUE_abc123`
   - åªæœ‰ `_id` å­—æ®µçš„æ—§å·¥å•: `issue_xxx`

2. **æ›´å¥½çš„è°ƒè¯•ä¿¡æ¯**: æ·»åŠ äº†è¯¦ç»†çš„æ§åˆ¶å°æ—¥å¿—ï¼Œä¾¿äºæ’æŸ¥é—®é¢˜

3. **ç”¨æˆ·ä½“éªŒæ”¹å–„**: 
   - ä¸å†æ˜¾ç¤º"åŠ è½½å¤±è´¥"é”™è¯¯
   - è¯„ä»·åŠŸèƒ½æ­£å¸¸å·¥ä½œ

## æµ‹è¯•å»ºè®®

1. æµ‹è¯•æ–°åˆ›å»ºçš„å·¥å•ï¼ˆæœ‰ `issueId` å­—æ®µï¼‰
2. æµ‹è¯•æ—§çš„å·¥å•ï¼ˆåªæœ‰ `_id` å­—æ®µï¼‰
3. æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—ï¼Œç¡®è®¤æŸ¥è¯¢è¿‡ç¨‹æ­£å¸¸
4. éªŒè¯è¯„ä»·æäº¤æˆåŠŸåï¼Œæ•°æ®æ­£ç¡®ä¿å­˜

## æ³¨æ„äº‹é¡¹

1. äº‘å‡½æ•°ä¿®æ”¹åéœ€è¦é‡æ–°ä¸Šä¼ éƒ¨ç½²
2. å‰ç«¯ä»£ç ä¿®æ”¹åéœ€è¦é‡æ–°ç¼–è¯‘
3. å»ºè®®åœ¨æµ‹è¯•ç¯å¢ƒå…ˆéªŒè¯åŠŸèƒ½æ­£å¸¸

## ç›¸å…³æ–‡ä»¶

- `pages/manager/rating-feedback/rating-feedback.js`
- `pages/manager/rate-issue/rate-issue.js`
- `pages/client/rate-issue/rate-issue.js`
- `cloud/functions/issues/index.js`

---

ä¿®å¤æ—¥æœŸ: 2025-11-01

