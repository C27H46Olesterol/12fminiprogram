# 主管待处理页面更新说明

## 更新日期
2025-11-01

## 问题描述
主管端"待处理问题"页面存在以下问题：
1. 无法查看已经分配给维修工但还未发出配件的"处理中"工单
2. 工单卡片上没有显示问题编号，必须点进详情才能看到
3. "处理中"状态的工单只显示"查看详情"和"发送提醒"按钮，没有显示具体的操作按钮（如"开始处理"、"发出配件"等）

## 解决方案
1. 在"待处理问题"页面添加新的筛选标签 **"处理中"**，用于显示已分配给维修工且正在处理但尚未进入配件流程的工单
2. **在所有工单卡片上显示问题编号**，方便快速识别
3. **"处理中"标签根据工单状态显示具体操作按钮**：
   - `assigned` 状态：显示"开始处理"按钮
   - `processing` 状态且需要配件：显示"发出配件"按钮
   - `processing` 状态且不需要配件：显示"完成任务"按钮
4. 移除不必要的"发送提醒"按钮

---

## 修改内容

### 1. 前端页面修改

#### 1.1 `pages/manager/pending/pending.js`

**修改点 1: 添加新筛选类型**
- 在 `filterTypes` 数组中新增 `{ value: 'processing', label: '处理中', count: 0 }`
- 位置：第 16-21 行

```javascript
filterTypes: [
  { value: 'pending', label: '待分配', count: 0 },
  { value: 'processing', label: '处理中', count: 0 },  // 新增
  { value: 'parts_request', label: '待发件', count: 0 },
  { value: 'parts_sent', label: '待返件', count: 0 },
  { value: 'parts_received', label: '待完成', count: 0 }
]
```

**修改点 2: 更新状态数量查询**
- 在 `loadStatusCounts()` 函数中新增对"处理中"状态的数量查询
- 查询 `selectedStatus: 'processing'` 
- 位置：第 101-111 行

```javascript
// 获取处理中数量（assigned和processing状态）
const processingResult = await wx.cloud.callFunction({
  name: 'issues',
  data: {
    action: 'getAssignedIssues',
    page: 1,
    pageSize: 1,
    selectedStatus: 'processing',
    phoneNumber: phoneNumber
  }
});
```

**修改点 3: 更新数量显示**
- 更新 `filterTypes` 数组索引，正确映射各状态数量
- 位置：第 150-155 行

```javascript
filterTypes[0].count = pendingResult.result?.data?.total || 0;
filterTypes[1].count = processingResult.result?.data?.total || 0;  // 新增
filterTypes[2].count = partsRequestResult.result?.data?.total || 0;
filterTypes[3].count = partsSentResult.result?.data?.total || 0;
filterTypes[4].count = partsReceivedResult.result?.data?.total || 0;
```

#### 1.2 `pages/manager/pending/pending.wxml`

**修改点 1: 添加问题编号显示**
- 位置：第 58-62 行
- 在所有工单卡片顶部显示问题编号

```xml
<!-- 问题编号 -->
<view class="issue-number">
  <text class="number-label">编号:</text>
  <text class="number-value">{{item.issueNumber || item._id}}</text>
</view>
```

**修改点 2: 修改"处理中"操作按钮**
- 位置：第 115-136 行
- 根据工单状态显示不同的操作按钮

```xml
<!-- 处理中：根据状态显示不同操作按钮 -->
<block wx:if="{{filterType === 'processing'}}">
  <!-- assigned状态：显示开始处理 -->
  <button wx:if="{{item.status === 'assigned'}}" class="btn-start" size="mini" catchtap="startProcessing" data-id="{{item._id}}">
    开始处理
  </button>
  
  <!-- processing状态且需要配件：显示发出配件 -->
  <button wx:if="{{item.status === 'processing' && item.needParts}}" class="btn-send-parts" size="mini" catchtap="sendParts" data-id="{{item._id}}">
    发出配件
  </button>
  
  <!-- processing状态且不需要配件：显示完成任务 -->
  <button wx:if="{{item.status === 'processing' && !item.needParts}}" class="btn-complete" size="mini" catchtap="completeTask" data-id="{{item._id}}">
    完成任务
  </button>
  
  <!-- 查看详情按钮 -->
  <button class="btn-detail" size="mini" catchtap="viewDetail" data-id="{{item._id}}">
    查看详情
  </button>
</block>
```

#### 1.3 `pages/manager/pending/pending.wxss`

**修改点: 添加"发送提醒"按钮样式**
- 位置：第 840-859 行
- 橙色渐变背景，与其他按钮风格保持一致

```css
/* 发送提醒按钮（处理中状态） */
.btn-remind {
  flex: 1;
  background: linear-gradient(135deg, #ff9800 0%, #fb8c00 100%);
  color: white;
  border: none;
  font-size: 26rpx;
  height: 68rpx;
  line-height: 68rpx;
  border-radius: 12rpx;
  font-weight: 500;
  letter-spacing: 0.5rpx;
  box-shadow: 0 4rpx 12rpx rgba(255, 152, 0, 0.3);
  transition: all 0.3s ease;
}
```

---

### 2. 云函数修改

#### 2.1 `cloud/functions/issues/index.js`

**修改点: 更新 `getAssignedIssues` 函数的查询逻辑**
- 位置：第 733-741 行
- 当 `selectedStatus === 'processing'` 时，同时查询 `assigned` 和 `processing` 两种状态

```javascript
let query;
if (selectedStatus) {
  // 特殊处理：processing 状态包含 assigned 和 processing
  if (selectedStatus === 'processing') {
    query = { status: _.in(['assigned', 'processing']) };
  } else {
    query = { status: selectedStatus };
  }
} else {
  query = { status: _.in(['assigned', 'processing', 'parts_request', 'parts_sent', 'parts_return_approval', 'parts_received']) };
}
```

---

## 工单状态流程

更新后的工单状态流程如下：

```
1. pending (待分配)
   ↓ [主管分配维修工]
   
2. assigned/processing (处理中) ← 新增显示
   ↓ [维修工开始处理/申请配件]
   
3. parts_request (待发件)
   ↓ [主管发出配件]
   
4. parts_sent (待返件)
   ↓ [维修工发回返件]
   
5. parts_received (待完成)
   ↓ [主管完成任务]
   
6. resolved (已解决)
```

---

## 页面标签说明

| 标签名称 | 状态值 | 说明 | 主要操作 |
|---------|--------|------|---------|
| 待分配 | `pending` | 刚提交的工单，尚未分配维修工 | 分配任务、查看详情 |
| **处理中** | `assigned`, `processing` | **已分配维修工，正在处理但未申请配件** | **查看详情、发送提醒** |
| 待发件 | `parts_request` | 维修工已申请配件，等待主管发出 | 发出配件、查看详情 |
| 待返件 | `parts_sent` | 配件已发出，等待维修工返件 | 发出返件、查看详情 |
| 待完成 | `parts_received` | 返件已收到，等待主管确认完成 | 完成任务、查看详情 |

---

## 测试步骤

### 1. 测试"处理中"标签显示

#### 准备工作
1. 确保数据库中有 `assigned` 或 `processing` 状态的工单
2. 如果没有，可以手动创建：
   - 创建新工单（状态为 `pending`）
   - 分配给维修工（状态变为 `assigned`）
   - 维修工开始处理（状态变为 `processing`）

#### 测试步骤
1. 登录主管账号
2. 进入"待处理问题"页面
3. 点击"处理中"标签
4. 验证显示的工单：
   - ✅ 显示已分配但未申请配件的工单
   - ✅ 显示维修工信息（姓名、手机号）
   - ✅ 显示分配时间
   - ✅ 数量徽章正确显示

#### 预期结果
- 能看到所有 `assigned` 和 `processing` 状态的工单
- 每个工单卡片显示"查看详情"和"发送提醒"按钮
- 点击"查看详情"能跳转到详情页
- 点击"发送提醒"弹出确认对话框

---

### 2. 测试其他标签不受影响

#### 测试步骤
1. 逐个点击所有标签：
   - 待分配
   - 处理中
   - 待发件
   - 待返件
   - 待完成
2. 验证每个标签显示的工单状态正确
3. 验证数量徽章与实际工单数量一致

#### 预期结果
- 所有标签正常工作
- 数据不混乱，各标签显示对应状态的工单
- 切换标签流畅，无卡顿

---

### 3. 测试云函数

#### 测试方法
在云函数控制台测试 `getAssignedIssues`：

```javascript
// 测试查询"处理中"工单
{
  "action": "getAssignedIssues",
  "page": 1,
  "pageSize": 10,
  "selectedStatus": "processing",
  "phoneNumber": "主管手机号"
}
```

#### 预期结果
- 返回 `assigned` 和 `processing` 状态的工单
- 数量统计正确
- 包含维修工手机号等信息

---

## 常见问题

### Q1: "处理中"标签没有显示工单？
**A:** 检查以下几点：
1. 数据库中是否有 `assigned` 或 `processing` 状态的工单
2. 云函数是否已重新部署
3. 小程序是否已重新编译

### Q2: 数量徽章显示不正确？
**A:** 
1. 刷新页面（下拉刷新）
2. 检查云函数返回的 `total` 字段
3. 查看控制台日志，确认查询条件正确

### Q3: 点击"发送提醒"没有反应？
**A:**
1. 检查 `sendReminder` 函数是否正确绑定
2. 查看控制台是否有错误日志
3. 确认云函数权限正常

---

## 部署步骤

### 1. 部署云函数
```bash
# 在微信开发者工具中
1. 右键点击 cloud/functions/issues 文件夹
2. 选择"上传并部署：云端安装依赖"
3. 等待部署完成
```

### 2. 编译小程序
```bash
1. 点击工具栏的"编译"按钮
2. 检查控制台是否有错误
3. 在模拟器中测试功能
```

### 3. 真机测试
```bash
1. 点击"预览"按钮
2. 用手机扫码打开小程序
3. 测试所有标签功能
4. 验证数据显示正确
```

---

## 注意事项

1. **云函数必须重新部署**
   - 修改了 `getAssignedIssues` 的查询逻辑
   - 不部署云函数，前端修改无效

2. **数据兼容性**
   - 兼容旧数据（只有 `assigned` 状态）
   - 兼容新数据（包含 `processing` 状态）

3. **性能优化**
   - 使用 `_.in()` 查询多个状态，只需一次数据库查询
   - 数量统计使用 `pageSize: 1` 减少数据传输

4. **用户体验**
   - 标签名称清晰易懂
   - 按钮颜色区分功能
   - 提供"发送提醒"功能，方便主管催促维修工

---

## 后续优化建议

1. **发送提醒功能增强**
   - 实现真实的消息推送
   - 记录提醒历史
   - 限制提醒频率（避免骚扰）

2. **数据统计**
   - 统计每个维修工的处理时长
   - 标记超时未处理的工单
   - 提供处理效率报表

3. **状态自动流转**
   - 长时间未处理自动提醒
   - 超时自动重新分配
   - 配件发出后自动更新状态

---

## 版本记录

- **v1.1** (2025-01-XX)
  - 新增"处理中"标签
  - 支持查看已分配但未申请配件的工单
  - 添加"发送提醒"功能

- **v1.0** (2025-01-XX)
  - 初始版本
  - 基础的待处理、待发件、待返件、待完成功能

---

**文档编写**: AI Assistant  
**最后更新**: 2025-01-XX

